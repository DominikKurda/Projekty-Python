from __future__ import annotations

import json
import os
from dataclasses import dataclass, asdict
from datetime import datetime
from typing import Dict, List

from flask import Flask, request, redirect, url_for, flash, render_template_string

APP_TITLE = "English Trainer ‚Äì UK Edition"
DATA_FILE = "words.json"

app = Flask(__name__)
app.secret_key = "change-me-please"  # zmie≈Ñ na co≈õ w≈Çasnego


# ============================
# Model s≈Ç√≥wka + zapis do JSON
# ============================

@dataclass
class Word:
    id: str
    en: str
    pl: str
    example: str = ""
    notes: str = ""
    tags: List[str] | None = None
    created_at: str = ""

    def to_dict(self) -> dict:
        d = asdict(self)
        d["tags"] = self.tags or []
        return d

    @staticmethod
    def from_dict(d: dict) -> "Word":
        return Word(
            id=d.get("id", ""),
            en=(d.get("en", "") or "").strip(),
            pl=(d.get("pl", "") or "").strip(),
            example=d.get("example", "") or "",
            notes=d.get("notes", "") or "",
            tags=d.get("tags", []) or [],
            created_at=d.get("created_at", "") or "",
        )


def now_iso() -> str:
    return datetime.now().isoformat(timespec="seconds")


def load_words() -> Dict[str, Word]:
    if not os.path.exists(DATA_FILE):
        seed = seed_words()
        save_words(seed)
        return seed

    with open(DATA_FILE, "r", encoding="utf-8") as f:
        raw = json.load(f)

    words: Dict[str, Word] = {}
    for item in raw.get("words", []):
        w = Word.from_dict(item)
        if w.id:
            if not w.created_at:
                w.created_at = now_iso()
            words[w.id] = w
    return words


def save_words(words: Dict[str, Word]) -> None:
    payload = {"words": [w.to_dict() for w in words.values()]}
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(payload, f, ensure_ascii=False, indent=2)


def seed_words() -> Dict[str, Word]:
    # Przyk≈Çadowa baza startowa ‚Äì mo≈ºesz zresetowaƒá rƒôcznie usuwajƒÖc plik words.json
    base = [
        # lesson1
        ("Hi!", "Cze≈õƒá!", "Hi! My name is Tom.", ["lesson1", "everyday"]),
        ("Hello!", "Witaj! / Dzie≈Ñ dobry!", "Hello! Nice to meet you.", ["lesson1", "everyday"]),
        ("My name is ...", "Mam na imiƒô ...", "My name is Anna.", ["lesson1"]),
        ("What's your name?", "Jak masz na imiƒô?", "What's your name?", ["lesson1"]),
        ("Nice to meet you.", "Mi≈Ço mi ciƒô poznaƒá.", "Nice to meet you.", ["lesson1"]),
        ("How are you?", "Jak siƒô masz?", "How are you today?", ["lesson1"]),
        ("I'm fine, thanks.", "W porzƒÖdku, dziƒôki.", "I'm fine, thanks.", ["lesson1"]),
        ("Where are you from?", "SkƒÖd jeste≈õ?", "Where are you from?", ["lesson1"]),
        ("I'm from Poland.", "Jestem z Polski.", "I'm from Poland.", ["lesson1"]),
        ("Goodbye!", "Do widzenia!", "Goodbye! See you.", ["lesson1"]),

        # lesson2
        ("How old are you?", "Ile masz lat?", "How old are you?", ["lesson2"]),
        ("I'm ... years old.", "Mam ... lat.", "I'm 25 years old.", ["lesson2"]),
        ("I was born in ...", "Urodzi≈Çem/am siƒô w ...", "I was born in 2000.", ["lesson2"]),
        ("When were you born?", "Kiedy siƒô urodzi≈Çe≈õ/urodzi≈Ça≈õ?", "When were you born?", ["lesson2"]),
        ("I'm a student.", "Jestem studentem/studentkƒÖ.", "I'm a student.", ["lesson2"]),
        ("I work as a ...", "Pracujƒô jako ...", "I work as a programmer.", ["lesson2"]),
        ("What do you do?", "Czym siƒô zajmujesz?", "What do you do?", ["lesson2"]),
        ("I live in ...", "Mieszkam w ...", "I live in Krak√≥w.", ["lesson2"]),
        ("That's interesting.", "To ciekawe.", "That's interesting.", ["lesson2"]),

        # Airport module (tags)
        ("I‚Äôd like to check in, please.", "Chcia≈Çbym siƒô odprawiƒá.", "", ["airport", "lesson31"]),
        ("Here is my passport and ticket.", "Oto paszport i bilet.", "", ["airport", "lesson31"]),
        ("I have a reservation.", "Mam rezerwacjƒô.", "", ["airport", "lesson31"]),
        ("I have luggage to check in.", "Mam baga≈º do nadania.", "", ["airport", "lesson31"]),
        ("I have only hand luggage.", "Mam tylko baga≈º podrƒôczny.", "", ["airport", "lesson31"]),
        ("Can I have a window seat?", "Czy mogƒô dostaƒá miejsce przy oknie?", "", ["airport", "lesson31"]),
        ("Can I have an aisle seat?", "Czy mogƒô dostaƒá miejsce przy przej≈õciu?", "", ["airport", "lesson31"]),
        ("Is the flight on time?", "Czy lot jest punktualny?", "", ["airport", "lesson31"]),
    ]

    words: Dict[str, Word] = {}
    for i, (en, pl, ex, tags) in enumerate(base, start=1):
        wid = f"w{i:04d}"
        w = Word(
            id=wid,
            en=en,
            pl=pl,
            example=ex,
            notes="",
            tags=tags,
            created_at=now_iso(),
        )
        words[w.id] = w
    return words


# ============================
# TTS helpers (üîä)
# ============================

def tts_btn(text: str, size: str = "sm") -> str:
    import html as html_escape
    safe = html_escape.escape(text or "", quote=True)
    cls = "tts-btn tts-sm" if size == "sm" else "tts-btn"
    return f'<button type="button" class="{cls}" data-tts="{safe}" title="Ods≈Çuchaj">üîä</button>'


# ============================
# Materia≈Çy (teoria/gramatyka)
# + przymiotniki
# ============================

MATERIALS = [
    {
        "id": "past_to_be",
        "title": "Czas przesz≈Çy ‚Äì TO BE (was / were)",
        "sections": [
            {
                "title": "Forma twierdzƒÖca",
                "items": [
                    {"en": "I was", "pl": "ja by≈Çem / ja by≈Çam"},
                    {"en": "you were", "pl": "ty by≈Çe≈õ / ty by≈Ça≈õ"},
                    {"en": "he was", "pl": "on by≈Ç"},
                    {"en": "she was", "pl": "ona by≈Ça"},
                    {"en": "it was", "pl": "to by≈Ço"},
                    {"en": "we were", "pl": "my byli≈õmy / my by≈Çy≈õmy"},
                    {"en": "you were", "pl": "wy byli≈õcie / wy by≈Çy≈õcie"},
                    {"en": "they were", "pl": "oni byli / one by≈Çy"},
                ],
            },
            {
                "title": "Forma przeczƒÖca",
                "items": [
                    {"en": "I wasn‚Äôt", "pl": "ja nie by≈Çem / ja nie by≈Çam"},
                    {"en": "you weren‚Äôt", "pl": "ty nie by≈Çe≈õ / ty nie by≈Ça≈õ"},
                    {"en": "he wasn‚Äôt", "pl": "on nie by≈Ç"},
                    {"en": "she wasn‚Äôt", "pl": "ona nie by≈Ça"},
                    {"en": "it wasn‚Äôt", "pl": "to nie by≈Ço"},
                    {"en": "we weren‚Äôt", "pl": "my nie byli≈õmy / my nie by≈Çy≈õmy"},
                    {"en": "you weren‚Äôt", "pl": "wy nie byli≈õcie / wy nie by≈Çy≈õcie"},
                    {"en": "they weren‚Äôt", "pl": "oni nie byli / one nie by≈Çy"},
                ],
            },
            {
                "title": "W skr√≥cie",
                "items": [
                    {"en": "was ‚Üí I / he / she / it", "pl": "was u≈ºywamy z: I / he / she / it"},
                    {"en": "were ‚Üí you / we / they", "pl": "were u≈ºywamy z: you / we / they"},
                    {"en": "was not = wasn‚Äôt", "pl": "skr√≥cona forma"},
                    {"en": "were not = weren‚Äôt", "pl": "skr√≥cona forma"},
                ],
            },
        ],
        "examples": [
            {"en": "I was at home yesterday.", "pl": "By≈Çem / by≈Çam wczoraj w domu."},
            {"en": "She wasn‚Äôt happy.", "pl": "Ona nie by≈Ça szczƒô≈õliwa."},
            {"en": "We were tired after work.", "pl": "Byli≈õmy zmƒôczeni po pracy."},
            {"en": "They weren‚Äôt at the airport.", "pl": "Oni nie byli na lotnisku."},
        ],
    },
    {
        "id": "adjectives_pack",
        "title": "Przymiotniki ‚Äì zestaw (A1/A2) + wymowa",
        "sections": [
            {
                "title": "Lista",
                "items": [
                    {"en": "cheap", "pl": "tani"},
                    {"en": "expensive", "pl": "drogi"},
                    {"en": "boring", "pl": "nudny"},
                    {"en": "bored", "pl": "znudzony"},
                    {"en": "sad", "pl": "smutny"},
                    {"en": "famous", "pl": "s≈Çawny (wymowa: /Ààfe…™m…ôs/ ‚Äûfejmes‚Äù)"},
                    {"en": "light", "pl": "jasny / lekki (kontekst)"},
                    {"en": "awful", "pl": "okropny"},
                    {"en": "smart", "pl": "mƒÖdry / inteligentny"},
                    {"en": "clever", "pl": "sprytny"},
                    {"en": "surprised", "pl": "zaskoczony"},
                    {"en": "heavy", "pl": "ciƒô≈ºki"},
                    {"en": "dirty", "pl": "brudny (wymowa: ‚Äûdirdi‚Äù)"},
                    {"en": "clean", "pl": "czysty"},
                    {"en": "quiet", "pl": "cichy"},
                    {"en": "modern", "pl": "nowoczesny"},
                    {"en": "old-fashioned", "pl": "staromodny"},
                    {"en": "angry", "pl": "z≈Çy"},
                    {"en": "worried", "pl": "zmartwiony"},
                    {"en": "nervous", "pl": "zdenerwowany"},
                    {"en": "confident", "pl": "pewny siebie"},
                    {"en": "excited", "pl": "podekscytowany"},
                ],
            }
        ],
        "examples": [
            {"en": "This phone is cheap.", "pl": "Ten telefon jest tani."},
            {"en": "I‚Äôm bored.", "pl": "Nudzƒô siƒô / jestem znudzony."},
            {"en": "She is confident.", "pl": "Ona jest pewna siebie."},
        ],
    },
]


# ============================
# LEKCJE ‚Äì tylko s≈Çownictwo
# ============================

def norm(s: str) -> str:
    s = (s or "").strip().lower()
    for ch in ["!", ".", ",", "?", ";", ":", "‚Äô", "'", "‚Ä¶", "‚Äì", "‚Äî"]:
        s = s.replace(ch, "")
    s = " ".join(s.split())
    return s


LESSONS = [
    {
        "id": 1,
        "title": "Lekcja 1: Podstawowe zwroty ‚Äì przedstawianie siƒô",
        "level": "A1",
        "goal": "Umiesz siƒô przywitaƒá, przedstawiƒá i zapytaƒá o imiƒô.",
        "required_phrases": [
            {"en": "Hi!", "pl": "Cze≈õƒá!"},
            {"en": "Hello!", "pl": "Witaj! / Dzie≈Ñ dobry!"},
            {"en": "My name is ...", "pl": "Mam na imiƒô ..."},
            {"en": "What's your name?", "pl": "Jak masz na imiƒô?"},
            {"en": "Nice to meet you.", "pl": "Mi≈Ço mi ciƒô poznaƒá."},
            {"en": "How are you?", "pl": "Jak siƒô masz?"},
            {"en": "I'm fine, thanks.", "pl": "W porzƒÖdku, dziƒôki."},
            {"en": "Where are you from?", "pl": "SkƒÖd jeste≈õ?"},
            {"en": "I'm from Poland.", "pl": "Jestem z Polski."},
            {"en": "Goodbye!", "pl": "Do widzenia!"},
        ],
    },
    {
        "id": 2,
        "title": "Lekcja 2: Ile masz lat? ‚Äì wiek, data urodzenia i zajƒôcie",
        "level": "A1/A2",
        "goal": "Umiesz zapytaƒá o wiek, powiedzieƒá ile masz lat i czym siƒô zajmujesz.",
        "required_phrases": [
            {"en": "How old are you?", "pl": "Ile masz lat?"},
            {"en": "I'm ... years old.", "pl": "Mam ... lat."},
            {"en": "When were you born?", "pl": "Kiedy siƒô urodzi≈Çe≈õ/urodzi≈Ça≈õ?"},
            {"en": "I was born in ...", "pl": "Urodzi≈Çem/am siƒô w ..."},
            {"en": "What do you do?", "pl": "Czym siƒô zajmujesz?"},
            {"en": "I'm a student.", "pl": "Jestem studentem/studentkƒÖ."},
            {"en": "I work as a ...", "pl": "Pracujƒô jako ..."},
            {"en": "I live in ...", "pl": "Mieszkam w ..."},
            {"en": "That's interesting.", "pl": "To ciekawe."},
        ],
    },
    {
        "id": 21,
        "title": "Lekcja 2.1: Opis o sobie ‚Äì Dominik (A1/A2)",
        "level": "A1/A2",
        "goal": "Umiesz kr√≥tko opisaƒá siebie: imiƒô, wiek, zaw√≥d, miejsce i wyglƒÖd.",
        "required_phrases": [
            {"en": "My name is Dominik.", "pl": "Mam na imiƒô Dominik."},
            {"en": "I am 22 years old.", "pl": "Mam 22 lata."},
            {"en": "I am a software tester in IT.", "pl": "Jestem testerem oprogramowania w IT."},
            {"en": "I live in Bzinica Stara in Poland.", "pl": "Mieszkam w Bzinicy Starej w Polsce."},
            {"en": "I have got blue eyes.", "pl": "Mam niebieskie oczy."},
            {"en": "I have got brown hair.", "pl": "Mam brƒÖzowe w≈Çosy."},
            {"en": "I have got a light face.", "pl": "Mam jasnƒÖ twarz."},
            {"en": "I have got a short beard.", "pl": "Mam kr√≥tkƒÖ brodƒô."},
            {"en": "I wear glasses.", "pl": "Noszƒô okulary."},
        ],
    },
    {
        "id": 31,
        "title": "Lekcja 3.1: Lotnisko ‚Äì Odprawa / Check-in (Pasa≈ºer)",
        "level": "A1/A2",
        "goal": "Umiesz przej≈õƒá odprawƒô: check-in, dokumenty, baga≈º, miejsce i punktualno≈õƒá.",
        "required_phrases": [
            {"en": "I‚Äôd like to check in, please.", "pl": "Chcia≈Çbym siƒô odprawiƒá."},
            {"en": "Here is my passport and ticket.", "pl": "Oto paszport i bilet."},
            {"en": "I have a reservation.", "pl": "Mam rezerwacjƒô."},
            {"en": "I have luggage to check in.", "pl": "Mam baga≈º do nadania."},
            {"en": "I have only hand luggage.", "pl": "Mam tylko baga≈º podrƒôczny."},
            {"en": "Can I have a window seat?", "pl": "Czy mogƒô dostaƒá miejsce przy oknie?"},
            {"en": "Can I have an aisle seat?", "pl": "Czy mogƒô dostaƒá miejsce przy przej≈õciu?"},
            {"en": "Is the flight on time?", "pl": "Czy lot jest punktualny?"},
        ],
    },
    {
        "id": 32,
        "title": "Lekcja 3.2: Lotnisko ‚Äì Odprawa / Check-in (Obs≈Çuga)",
        "level": "A1/A2",
        "goal": "Rozumiesz pytania obs≈Çugi podczas odprawy.",
        "required_phrases": [
            {"en": "May I see your passport?", "pl": "Czy mogƒô zobaczyƒá paszport?"},
            {"en": "How many bags are you checking in?", "pl": "Ile baga≈ºy nadajesz?"},
            {"en": "Here is your boarding pass.", "pl": "Oto karta pok≈Çadowa."},
        ],
    },
    {
        "id": 33,
        "title": "Lekcja 3.3: Lotnisko ‚Äì Baga≈º (Baggage)",
        "level": "A1/A2",
        "goal": "Znasz podstawowe s≈Çownictwo dotyczƒÖce baga≈ºu na lotnisku.",
        "required_phrases": [
            {"en": "checked baggage", "pl": "baga≈º rejestrowany"},
            {"en": "carry-on baggage", "pl": "baga≈º podrƒôczny"},
            {"en": "hand luggage", "pl": "baga≈º podrƒôczny"},
            {"en": "overweight baggage", "pl": "baga≈º z nadwagƒÖ"},
            {"en": "fragile", "pl": "delikatny"},
            {"en": "lost luggage", "pl": "zagubiony baga≈º"},
        ],
    },
    {
        "id": 34,
        "title": "Lekcja 3.4: Lotnisko ‚Äì Kontrola bezpiecze≈Ñstwa (Security)",
        "level": "A1/A2",
        "goal": "Rozumiesz polecenia i pytania obs≈Çugi podczas kontroli bezpiecze≈Ñstwa.",
        "required_phrases": [
            {"en": "Please remove your shoes.", "pl": "Proszƒô zdjƒÖƒá buty."},
            {"en": "Take your laptop out of the bag.", "pl": "Wyjmij laptopa z torby."},
            {"en": "Put your liquids in the tray.", "pl": "W≈Ç√≥≈º p≈Çyny do pojemnika."},
            {"en": "Walk through the scanner.", "pl": "Przejd≈∫ przez skaner."},
            {"en": "Do you have any liquids?", "pl": "Czy masz jakie≈õ p≈Çyny?"},
        ],
    },
    {
        "id": 35,
        "title": "Lekcja 3.5: Lotnisko ‚Äì Kontrola paszportowa (Passport Control)",
        "level": "A1/A2",
        "goal": "Potrafisz odpowiedzieƒá: cel podr√≥≈ºy, czas pobytu, miejsce zakwaterowania.",
        "required_phrases": [
            {"en": "What is the purpose of your visit?", "pl": "Jaki jest cel wizyty?"},
            {"en": "Tourism", "pl": "Turystyka"},
            {"en": "Business", "pl": "Biznes"},
            {"en": "Work", "pl": "Praca"},
            {"en": "How long are you staying?", "pl": "Jak d≈Çugo zostajesz?"},
            {"en": "Where will you stay?", "pl": "Gdzie bƒôdziesz mieszkaƒá?"},
        ],
    },
    {
        "id": 36,
        "title": "Lekcja 3.6: Lotnisko ‚Äì Informacje o locie (Flight Information)",
        "level": "A1/A2",
        "goal": "Rozumiesz: departure/arrival, gate, boarding, delayed/cancelled oraz pytania o bramkƒô/boarding.",
        "required_phrases": [
            {"en": "departure", "pl": "odlot"},
            {"en": "arrival", "pl": "przylot"},
            {"en": "gate", "pl": "bramka"},
            {"en": "boarding", "pl": "wej≈õcie na pok≈Çad"},
            {"en": "delayed", "pl": "op√≥≈∫niony"},
            {"en": "cancelled", "pl": "odwo≈Çany"},
            {"en": "What gate is the flight to London?", "pl": "Z kt√≥rej bramki jest lot do Londynu?"},
            {"en": "Is boarding starting?", "pl": "Czy zaczyna siƒô boarding?"},
        ],
    },
    {
        "id": 37,
        "title": "Lekcja 3.7: Na pok≈Çadzie samolotu (On board)",
        "level": "A1/A2",
        "goal": "Umiesz znale≈∫ƒá miejsce, zapytaƒá o torbƒô, wodƒô, miejsce zajƒôte i rozumiesz polecenie o pasach.",
        "required_phrases": [
            {"en": "Where is my seat?", "pl": "Gdzie jest moje miejsce?"},
            {"en": "Can I put my bag here?", "pl": "Czy mogƒô tu po≈Ço≈ºyƒá torbƒô?"},
            {"en": "Could I have some water, please?", "pl": "Czy mogƒô prosiƒá o wodƒô?"},
            {"en": "Is this seat taken?", "pl": "Czy to miejsce jest zajƒôte?"},
            {"en": "Fasten your seatbelt.", "pl": "Zapnij pasy."},
        ],
    },
    {
        "id": 38,
        "title": "Lekcja 3.8: Po przylocie ‚Äì Baga≈º, c≈Ço i og√≥lne zwroty",
        "level": "A1/A2",
        "goal": "Umiesz zapytaƒá o odbi√≥r baga≈ºu, zg≈Çosiƒá brak baga≈ºu, przej≈õƒá c≈Ço i u≈ºywaƒá uniwersalnych zwrot√≥w.",
        "required_phrases": [
            {"en": "Where is baggage claim?", "pl": "Gdzie jest odbi√≥r baga≈ºu?"},
            {"en": "My luggage didn‚Äôt arrive.", "pl": "M√≥j baga≈º nie dotar≈Ç."},
            {"en": "Nothing to declare.", "pl": "Nic do oclenia."},
            {"en": "Something to declare.", "pl": "Mam co≈õ do oclenia."},
            {"en": "Excuse me.", "pl": "Przepraszam."},
            {"en": "Thank you.", "pl": "Dziƒôkujƒô."},
            {"en": "Thanks a lot.", "pl": "Dziƒôkujƒô bardzo."},
            {"en": "Could you help me?", "pl": "Czy mo≈ºesz mi pom√≥c?"},
            {"en": "I don‚Äôt understand.", "pl": "Nie rozumiem."},
            {"en": "Could you repeat, please?", "pl": "Czy mo≈ºesz powt√≥rzyƒá?"},
        ],
    },
    {
        "id": 40,
        "title": "Lekcja 4: Kawiarnia ‚Äì Zamawianie kawy",
        "level": "A1",
        "goal": "Potrafisz zam√≥wiƒá kawƒô w kawiarni: wybraƒá rodzaj, dodatki, rozmiar i zap≈Çaciƒá.",
        "required_phrases": [
            {"en": "What coffee would you like?", "pl": "JakƒÖ kawƒô chcia≈Çby≈õ/chcia≈Çaby≈õ?"},
            {"en": "I would like a coffee, please.", "pl": "Poproszƒô kawƒô."},
            {"en": "cappuccino", "pl": "cappuccino"},
            {"en": "espresso", "pl": "espresso"},
            {"en": "iced coffee", "pl": "kawa mro≈ºona"},
            {"en": "Could I have some milk in my coffee, please?", "pl": "Poproszƒô mleko do kawy."},
            {"en": "Would you like any sugar?", "pl": "Czy chcia≈Çby≈õ/chcia≈Çaby≈õ cukier?"},
            {"en": "Without sugar.", "pl": "Bez cukru."},
            {"en": "What size would you like?", "pl": "Jaki rozmiar?"},
            {"en": "Medium, please.", "pl": "≈öredni, proszƒô."},
            {"en": "I‚Äôll pay by card.", "pl": "Zap≈Çacƒô kartƒÖ."},
        ],
    },
    {
        "id": 41,
        "title": "Lekcja 4.1: Restauracja ‚Äì Zamawianie jedzenia",
        "level": "A1/A2",
        "goal": "Potrafisz zam√≥wiƒá jedzenie: poprosiƒá o menu, z≈Ço≈ºyƒá zam√≥wienie, poprosiƒá o rachunek i zap≈Çaciƒá.",
        "required_phrases": [
            {"en": "A table for one / two, please.", "pl": "Stolik dla jednej osoby / dw√≥ch os√≥b, proszƒô."},
            {"en": "Could we have the menu, please?", "pl": "Czy mo≈ºemy prosiƒá o menu?"},
            {"en": "I would like to order, please.", "pl": "Chcia≈Çbym/chcia≈Çabym z≈Ço≈ºyƒá zam√≥wienie."},
            {"en": "I‚Äôll have the chicken, please.", "pl": "Poproszƒô kurczaka."},
            {"en": "Can I have a glass of water, please?", "pl": "Czy mogƒô prosiƒá o szklankƒô wody?"},
            {"en": "No onions, please.", "pl": "Bez cebuli, proszƒô."},
            {"en": "Could I get the bill, please?", "pl": "Czy mogƒô prosiƒá o rachunek?"},
            {"en": "Can I pay by card?", "pl": "Czy mogƒô zap≈Çaciƒá kartƒÖ?"},
            {"en": "Thank you. It was delicious.", "pl": "Dziƒôkujƒô. By≈Ço pyszne."},
        ],
    },
    {
        "id": 5,
        "title": "Lekcja 5: Angielski w Londynie ‚Äì kupowanie biletu",
        "level": "A1/A2",
        "goal": "Umiesz zapytaƒá, gdzie kupiƒá bilet, ile kosztuje i czy sƒÖ zni≈ºki / przewodnik audio.",
        "required_phrases": [
            {"en": "Where can I buy a ticket?", "pl": "Gdzie mogƒô kupiƒá bilet?"},

            {"en": "Is the audio guide included?", "pl": "Czy przewodnik audio jest wliczony?"},
            {"en": "Is there a discount for students?", "pl": "Czy jest zni≈ºka dla student√≥w?"},
            {"en": "Is there a discount for seniors?", "pl": "Czy jest zni≈ºka dla senior√≥w?"},
            {"en": "Can I buy a ticket online?", "pl": "Czy mogƒô kupiƒá bilet online?"},
        ],
    },

    # ‚úÖ NOWA LEKCJA 6 (poprawnie wstawiona)
    {
        "id": 6,
        "title": "Lekcja 6: Kupowanie bilet√≥w ‚Äì kino i koncert",
        "level": "A1/A2",
        "goal": "Umiesz kupiƒá bilety (kino/koncert): liczba bilet√≥w, godzina, miejsca, dostƒôpno≈õƒá i cena.",
        "required_phrases": [
            {"en": "How can I help you?", "pl": "Jak mogƒô pom√≥c?"},
            {"en": "I'd like two tickets for the film on screen 3, please.", "pl": "Poproszƒô dwa bilety na film na sali 3."},
            {"en": "Which time would you like?", "pl": "O kt√≥rej godzinie chcia≈Çby Pan/chcia≈Çaby Pani?"},
            {"en": "Six-thirty (6:30), please.", "pl": "Na sz√≥stƒÖ trzydzie≈õci (6:30), proszƒô."},
            {"en": "I'm sorry, the 6:30 film is sold out.", "pl": "Przepraszam, film o 6:30 jest wyprzedany."},
            {"en": "But there are some tickets available for the nine-thirty film.", "pl": "Ale sƒÖ dostƒôpne bilety na film o 9:30."},
            {"en": "That's OK.", "pl": "W porzƒÖdku. / Zgadzam siƒô."},
            {"en": "I'd like four tickets for a concert, please.", "pl": "Poproszƒô cztery bilety na koncert."},
            {"en": "Where do you want to sit?", "pl": "Gdzie chcecie usiƒÖ≈õƒá?"},
            {"en": "Near the front, please.", "pl": "Z przodu, proszƒô."},
            {"en": "Let me see.", "pl": "Ju≈º sprawdzam."},
            {"en": "Do you want to sit together?", "pl": "Chcecie usiƒÖ≈õƒá razem?"},
            {"en": "I'm sorry, there aren't any more seats together.", "pl": "Przepraszam, nie ma ju≈º miejsc obok siebie."},
            {"en": "How much is a ticket?", "pl": "Ile kosztuje bilet?"},
            {"en": "It's thirty pounds for a ticket.", "pl": "Bilet kosztuje trzydzie≈õci funt√≥w."},
            {"en": "So four tickets ‚Äì that's one hundred and twenty pounds.", "pl": "Wiƒôc cztery bilety ‚Äì to sto dwadzie≈õcia funt√≥w."},
        ],
    },
{
    "id": 7,
    "title": "Lekcja 7: Pogoda ‚Äì opisywanie warunk√≥w atmosferycznych",
    "level": "A1/A2",
    "goal": "Umiesz opisaƒá pogodƒô: zachmurzenie, temperaturƒô, wiatr, deszcz, burzƒô, mg≈Çƒô i ≈õnieg.",
    "required_phrases": [
        {"en": "sunny", "pl": "s≈Çonecznie"},
        {"en": "cloudy", "pl": "pochmurno"},
        {"en": "overcast", "pl": "ca≈Çkowicie pochmurno"},
        {"en": "rainy", "pl": "deszczowo"},
        {"en": "snowy", "pl": "≈õnie≈ºnie"},
        {"en": "windy", "pl": "wietrznie"},
        {"en": "stormy", "pl": "burzowo"},

        {"en": "hot", "pl": "gorƒÖco"},
        {"en": "warm", "pl": "ciep≈Ço"},
        {"en": "cool", "pl": "ch≈Çodno"},
        {"en": "freezing", "pl": "mro≈∫no"},

        {"en": "It's cold outside.", "pl": "Na zewnƒÖtrz jest zimno."},
        {"en": "It's very hot today.", "pl": "Dzi≈õ jest bardzo gorƒÖco."},

        {"en": "strong wind", "pl": "silny wiatr"},
        {"en": "gentle wind", "pl": "lekki wiatr"},
        {"en": "breeze", "pl": "bryza"},
        {"en": "The wind is blowing.", "pl": "Wieje wiatr."},
        {"en": "It's windy today.", "pl": "Dzi≈õ jest wietrznie."},

        {"en": "It's raining.", "pl": "Pada deszcz."},
        {"en": "It's pouring.", "pl": "Leje deszcz."},
        {"en": "light rain", "pl": "lekki deszcz"},
        {"en": "heavy rain", "pl": "ulewa"},

        {"en": "thunder", "pl": "grzmot"},
        {"en": "lightning", "pl": "piorun"},
        {"en": "There is a storm.", "pl": "Jest burza."},

        {"en": "fog", "pl": "mg≈Ça"},
        {"en": "mist", "pl": "lekka mg≈Ça"},
        {"en": "It's foggy.", "pl": "Jest mgli≈õcie."},
        {"en": "I can‚Äôt see clearly.", "pl": "Nie widzƒô wyra≈∫nie."},
        {"en": "Visibility is poor.", "pl": "Widoczno≈õƒá jest s≈Çaba."},

        {"en": "snow", "pl": "≈õnieg"},
        {"en": "It's snowing.", "pl": "Pada ≈õnieg."},
        {"en": "frost", "pl": "mr√≥z"},
        {"en": "icy", "pl": "oblodzony"},
        {"en": "The road is icy.", "pl": "Droga jest oblodzona."},
    ],
},
{
    "id": 71,
    "title": "Lekcja 7.1: Pogoda ‚Äì opinie i prognozy",
    "level": "A1/A2",
    "goal": "Umiesz wyraziƒá opiniƒô o pogodzie oraz powiedzieƒá, jaka bƒôdzie lub jak wyglƒÖda sytuacja pogodowa.",
    "required_phrases": [
        {"en": "It looks like rain.", "pl": "WyglƒÖda na deszcz."},
        {"en": "The weather is nice today.", "pl": "Dzi≈õ jest ≈Çadna pogoda."},
        {"en": "The weather is awful.", "pl": "Pogoda jest okropna."},
        {"en": "I like this weather.", "pl": "Lubiƒô takƒÖ pogodƒô."},
        {"en": "I don‚Äôt like cold weather.", "pl": "Nie lubiƒô zimnej pogody."},
    ],
},


]


def lesson_missing_phrases(words_dict: dict, lesson: dict) -> list:
    """Sprawdza, kt√≥rych zwrot√≥w z lekcji brakuje w s≈Çowniku."""
    words = list(words_dict.values())
    missing = []
    for rp in lesson["required_phrases"]:
        found = any(
            norm(w.en) == norm(rp["en"]) and norm(w.pl) == norm(rp["pl"])
            for w in words
        )
        if not found:
            missing.append(rp)
    return missing


# ============================
# UI (HTML/CSS ‚Äì paleta UK)
# ============================

BASE_HTML = """
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{title}}</title>
  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(circle at top left,#1f2937 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      margin:0;
    }
    a{color:#bfdbfe; text-decoration:none}
    a:hover{text-decoration:underline}

    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 18px;
      background:linear-gradient(90deg,#0b1120,#111827);
      border-bottom:2px solid rgba(248,250,252,0.12);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      z-index:40;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.03em; font-size:18px;
    }
    .flag{
      width:26px; height:18px; border-radius:3px;
      background:
        linear-gradient(180deg,#00247d 0,#00163f 100%);
      box-shadow:0 0 0 1px rgba(15,23,42,0.9);
      position:relative; overflow:hidden;
    }
    .flag:before,
    .flag:after{
      content:""; position:absolute; inset:0;
      background:
        linear-gradient(90deg,transparent 45%,#fff 45%,#fff 55%,transparent 55%),
        linear-gradient(180deg,transparent 45%,#fff 45%,#fff 55%,transparent 55%);
      mix-blend-mode:screen;
    }
    .flag:after{
      background:
        linear-gradient(63deg,transparent 45%,#c8102e 45%,#c8102e 55%,transparent 55%),
        linear-gradient(117deg,transparent 45%,#c8102e 45%,#c8102e 55%,transparent 55%);
      opacity:.9;
    }

    .nav a{
      margin-right:10px; padding:8px 11px; border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.35);
      font-size:13px;
      box-shadow:0 6px 16px rgba(15,23,42,0.6);
    }
    .nav a:hover{
      background:rgba(30,64,175,0.85);
      border-color:rgba(248,250,252,0.9);
      text-decoration:none;
    }

    .wrap{max-width:1100px; margin:0 auto; padding:18px}
    .grid{display:grid; grid-template-columns: 1.15fr 0.85fr; gap:16px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{
      background:rgba(15,23,42,0.92);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 18px 45px rgba(15,23,42,0.9);
      padding:14px;
    }

    .btn{
      display:inline-block; padding:10px 14px; border-radius:999px;
      background: linear-gradient(135deg,#1d4ed8,#e11d48);
      color:white; border:none; cursor:pointer; font-weight:700;
      box-shadow: 0 14px 30px rgba(15,23,42,0.8);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.06);
      box-shadow: 0 18px 38px rgba(15,23,42,0.95);
    }
    .btn:active{
      transform: translateY(0px);
      filter: brightness(0.97);
      box-shadow: 0 12px 24px rgba(15,23,42,0.85);
    }
    .btn-ghost{
      background:rgba(15,23,42,0.75);
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:none;
    }

    input, textarea, select{
      width:100%; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9); color:#e5e7eb;
      outline:none;
    }
    input:focus, textarea:focus, select:focus{
      border-color:#60a5fa;
      box-shadow:0 0 0 1px rgba(96,165,250,0.5);
    }
    textarea{min-height:84px; resize:vertical}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:700px){ .row{grid-template-columns:1fr} }
    .muted{opacity:.85; font-size:14px}
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      background:rgba(30,64,175,0.8);
      border:1px solid rgba(191,219,254,0.8);
      margin-right:6px; font-size:12px;
    }
    .list{display:flex; flex-direction:column; gap:10px}
    .hr{height:1px; background:rgba(148,163,184,0.5); margin:12px 0}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .big{font-size:26px; font-weight:900}

    .flash{
      padding:10px 12px; border-radius:14px; margin:0 0 12px 0;
      background:rgba(34,197,94,0.18);
      border:1px solid rgba(34,197,94,0.35)
    }
    .flash.err{
      background:rgba(239,68,68,0.15);
      border:1px solid rgba(239,68,68,0.35)
    }

    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(148,163,184,0.45); padding:10px; text-align:left}
    th{opacity:.9}

    /* ===== TTS ===== */
    .tts-btn{
      border:none; cursor:pointer; margin-left:8px;
      border-radius:999px; padding:7px 9px;
      background: rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.7);
      color:#e5e7eb;
      transition: transform .12s ease, filter .12s ease;
      font-size:13px;
    }
    .tts-btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.07);
    }
    .tts-btn:active{
      transform: translateY(0px);
      filter: brightness(0.97);
    }
    .tts-sm{padding:5px 7px; font-size:12px}

    .tts-panel{
      position:fixed; right:16px; bottom:16px; width:320px; max-width:calc(100vw - 32px);
      background: rgba(15,23,42,0.98);
      border:1px solid rgba(148,163,184,0.7);
      border-radius:18px; padding:12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 22px 55px rgba(0,0,0,0.85);
      display:none; z-index:60;
    }
    .tts-panel.show{display:block}
    .mini-btn{
      background: rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.7);
      color:#e5e7eb;
      border-radius:999px;
      padding:7px 10px;
      cursor:pointer;
      font-size:12px;
    }
    .mini-btn:hover{
      background:rgba(30,64,175,0.8);
      border-color:rgba(219,234,254,0.95);
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">
      <div class="flag"></div>
      <span>{{title}}</span>
    </div>
    <div class="nav">
      <a href="{{ url_for('home') }}">Start</a>
      <a href="{{ url_for('materials_list') }}">Materia≈Çy</a>
      <a href="{{ url_for('lessons_list') }}">Lekcje</a>
      <a href="{{ url_for('words_page') }}">S≈Çownik</a>
      <a href="#" id="ttsOpen">üîä Audio</a>
    </div>
  </div>
  <div class="wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat,msg in messages %}
          <div class="flash {% if cat=='err' %}err{% endif %}">{{msg}}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {{ body|safe }}
  </div>

  <!-- TTS panel -->
  <div class="tts-panel" id="ttsPanel" aria-hidden="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <b>üîä Wymowa (brytyjski angielski)</b>
      <button type="button" class="mini-btn" id="ttsClose">Zamknij</button>
    </div>
    <div class="hr"></div>

    <label style="font-size:12px; opacity:.9">G≈Ços</label>
    <select id="ttsVoice" style="width:100%; margin:6px 0 10px 0;"></select>

    <div style="display:flex; justify-content:space-between; align-items:center;">
      <label style="font-size:12px; opacity:.9">Szybko≈õƒá</label>
      <span id="ttsRateLabel" style="font-size:12px; opacity:.9">1.0√ó</span>
    </div>
    <input id="ttsRate" type="range" min="0.6" max="1.4" step="0.05" value="1.0" style="width:100%">

    <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
      <button type="button" class="mini-btn" id="ttsTest">Test</button>
      <button type="button" class="mini-btn" id="ttsStop">Stop</button>
    </div>

    <div style="font-size:12px; opacity:.8; margin-top:8px;">
      Ustawienia zapisujƒÖ siƒô w przeglƒÖdarce (g≈Ços + szybko≈õƒá). Domy≈õlnie wybieramy g≈Ços <b>en-GB</b>, je≈õli jest dostƒôpny.
    </div>
  </div>

  <script>
  (function(){
    const panel = document.getElementById('ttsPanel');
    const openBtn = document.getElementById('ttsOpen');
    const closeBtn = document.getElementById('ttsClose');
    const voiceSel = document.getElementById('ttsVoice');
    const rateInp = document.getElementById('ttsRate');
    const rateLbl = document.getElementById('ttsRateLabel');
    const testBtn = document.getElementById('ttsTest');
    const stopBtn = document.getElementById('ttsStop');

    const LS_VOICE = "tts_voice_uri";
    const LS_RATE = "tts_rate";

    function getRate(){
      const v = parseFloat(localStorage.getItem(LS_RATE) || "1.0");
      return isNaN(v) ? 1.0 : v;
    }
    function setRate(v){ localStorage.setItem(LS_RATE, String(v)); }
    function getVoiceUri(){ return localStorage.getItem(LS_VOICE) || ""; }
    function setVoiceUri(uri){ localStorage.setItem(LS_VOICE, uri); }

    function showPanel(){ panel.classList.add('show'); panel.setAttribute('aria-hidden','false'); }
    function hidePanel(){ panel.classList.remove('show'); panel.setAttribute('aria-hidden','true'); }

    openBtn && openBtn.addEventListener('click', (e)=>{ e.preventDefault(); showPanel(); });
    closeBtn && closeBtn.addEventListener('click', hidePanel);

    function stopSpeak(){ if ('speechSynthesis' in window) window.speechSynthesis.cancel(); }
    stopBtn && stopBtn.addEventListener('click', stopSpeak);

    function loadVoices(){
      if(!('speechSynthesis' in window)) return;
      const voices = window.speechSynthesis.getVoices() || [];
      const saved = getVoiceUri();
      voiceSel.innerHTML = "";
      voices.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.voiceURI;
        opt.textContent = `${v.name} (${v.lang})${v.default ? " ‚Ä¢ domy≈õlny" : ""}`;
        if (v.voiceURI === saved) opt.selected = true;
        voiceSel.appendChild(opt);
      });

      if(!saved && voices.length){
        const lower = (s)=> (s || "").toLowerCase();
        let pref =
          voices.find(v => lower(v.lang).startsWith("en-gb")) ||
          voices.find(v => lower(v.name).includes("uk english")) ||
          voices.find(v => lower(v.lang).startsWith("en-")) ||
          voices[0];

        if(pref){
          setVoiceUri(pref.voiceURI);
          [...voiceSel.options].forEach(o=> o.selected = (o.value === pref.voiceURI));
        }
      }
    }

    if ('speechSynthesis' in window){
      window.speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
    }

    const initRate = getRate();
    rateInp.value = initRate;
    rateLbl.textContent = initRate.toFixed(2) + "√ó";
    rateInp.addEventListener('input', ()=>{
      const v = parseFloat(rateInp.value);
      rateLbl.textContent = v.toFixed(2) + "√ó";
      setRate(v);
    });

    voiceSel.addEventListener('change', ()=> setVoiceUri(voiceSel.value));

    function pickVoice(){
      const uri = getVoiceUri();
      const voices = ('speechSynthesis' in window) ? (window.speechSynthesis.getVoices() || []) : [];
      return voices.find(v=> v.voiceURI === uri) || null;
    }

    function speak(text){
      if(!('speechSynthesis' in window)){
        alert("Brak wsparcia TTS w tej przeglƒÖdarce.");
        return;
      }
      stopSpeak();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if(v) u.voice = v;
      u.rate = getRate();
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);
    }

    testBtn && testBtn.addEventListener('click', ()=> speak("Hello! This is a British English test."));
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tts-btn');
      if(!btn) return;
      const txt = btn.getAttribute('data-tts') || "";
      if(!txt) return;
      speak(txt);
    });
  })();
  </script>
</body>
</html>
"""


def render(body_html: str, **ctx):
    return render_template_string(BASE_HTML, title=APP_TITLE, body=body_html, **ctx)


# ============================
# ROUTES
# ============================

@app.route("/")
def home():
    words = load_words()
    total = len(words)

    body = f"""
    <div class="card">
      <div class="big">Twoja nauka angielskiego üá¨üáß</div>
      <p class="muted">
        Dodajesz w≈Çasne zwroty do s≈Çownika, a lekcje pokazujƒÖ, czy wszystko ju≈º masz w bazie.
        <br>Ka≈ºde wyra≈ºenie ma przycisk üîä z wymowƒÖ w <b>brytyjskim</b> angielskim (je≈õli g≈Ços jest dostƒôpny w przeglƒÖdarce).
      </p>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div class="card">
        <h2>Dodaj nowe s≈Ç√≥wko</h2>
        <form method="post" action="{url_for('add_word')}">
          <div class="row">
            <div>
              <label>Angielski</label>
              <input name="en" placeholder="np. Where can I buy a ticket?" required>
            </div>
            <div>
              <label>Polski</label>
              <input name="pl" placeholder="np. Gdzie mogƒô kupiƒá bilet?" required>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Tagi (po przecinku)</label>
              <input name="tags" placeholder="np. lesson5, london, tickets">
            </div>
            <div>
              <label>Przyk≈Çad zdania</label>
              <input name="example" placeholder="np. Can I buy a ticket online?">
            </div>
          </div>
          <div style="margin-top:10px">
            <label>Notatki</label>
            <textarea name="notes" placeholder="np. wymowa, synonimy..."></textarea>
          </div>
          <div class="actions" style="margin-top:12px">
            <button class="btn" type="submit">Dodaj s≈Ç√≥wko</button>
            <a class="btn btn-ghost" href="{url_for('lessons_list')}">Lekcje</a>
            <a class="btn btn-ghost" href="{url_for('materials_list')}">Materia≈Çy</a>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Podsumowanie</h2>
        <p class="muted">S≈Ç√≥wka w bazie: <b>{total}</b></p>
        <div class="hr"></div>
        <p class="muted">
          Wejd≈∫ w <b>Lekcje</b>, ≈ºeby sprawdziƒá, czy wszystkie zwroty danej lekcji sƒÖ ju≈º w Twoim s≈Çowniku.
        </p>
        <div class="actions" style="margin-top:10px">
          <a class="btn" href="{url_for('lessons_list')}">Przejd≈∫ do lekcji</a>
          <a class="btn btn-ghost" href="{url_for('words_page')}">Otw√≥rz s≈Çownik</a>
        </div>
      </div>
    </div>
    """
    return render(body)


# ----------------------------
# MATERIA≈ÅY
# ----------------------------

@app.route("/materials")
def materials_list():
    cards = ""
    for m in MATERIALS:
        cards += f"""
        <div class="card">
          <h3 style="margin:0 0 6px 0">{m["title"]}</h3>
          <div class="actions" style="margin-top:10px">
            <a class="btn" href="{url_for('material_view', material_id=m['id'])}">Otw√≥rz</a>
          </div>
        </div>
        """

    body = f"""
    <div class="card">
      <h2>Materia≈Çy</h2>
      <p class="muted">
        Teoria/gramatyka w pigu≈Çce. Mo≈ºesz do nich wracaƒá w dowolnym momencie.
      </p>
    </div>
    <div class="hr"></div>
    <div class="list">{cards}</div>
    """
    return render(body)


@app.route("/materials/<material_id>")
def material_view(material_id: str):
    m = next((x for x in MATERIALS if x["id"] == material_id), None)
    if not m:
        flash("Nie znaleziono materia≈Çu.", "err")
        return redirect(url_for("materials_list"))

    sections_html = ""
    for sec in m.get("sections", []):
        rows = ""
        for it in sec.get("items", []):
            rows += f"<tr><td><b>{it['en']}</b> {tts_btn(it['en'])}</td><td>{it['pl']}</td></tr>"
        sections_html += f"""
        <div class="card">
          <h3 style="margin:0 0 10px 0">{sec["title"]}</h3>
          <table>
            <thead><tr><th>EN</th><th>PL</th></tr></thead>
            <tbody>{rows}</tbody>
          </table>
        </div>
        """

    ex_rows = ""
    for e in m.get("examples", []):
        ex_rows += f"<tr><td><b>{e['en']}</b> {tts_btn(e['en'])}</td><td>{e['pl']}</td></tr>"
    examples_html = f"""
    <div class="card">
      <h3 style="margin:0 0 10px 0">Przyk≈Çady</h3>
      <table>
        <thead><tr><th>EN</th><th>PL</th></tr></thead>
        <tbody>{ex_rows}</tbody>
      </table>
    </div>
    """ if m.get("examples") else ""

    body = f"""
    <div class="card">
      <h2>{m["title"]}</h2>
      <div class="actions" style="margin-top:10px">
        <a class="btn btn-ghost" href="{url_for('materials_list')}">Wr√≥ƒá</a>
        <a class="btn btn-ghost" href="{url_for('lessons_list')}">Lekcje</a>
      </div>
    </div>
    <div class="hr"></div>
    <div class="list">
      {sections_html}
      {examples_html}
    </div>
    """
    return render(body)


# ----------------------------
# S≈ÅOWNIK
# ----------------------------

@app.route("/add", methods=["POST"])
def add_word():
    words = load_words()

    en = (request.form.get("en", "") or "").strip()
    pl = (request.form.get("pl", "") or "").strip()
    if not en or not pl:
        flash("Uzupe≈Çnij angielski i polski.", "err")
        return redirect(url_for("home"))

    tags_raw = (request.form.get("tags", "") or "").strip()
    tags = [t.strip() for t in tags_raw.split(",") if t.strip()] if tags_raw else []

    wid = f"w{(len(words) + 1):04d}"
    w = Word(
        id=wid,
        en=en,
        pl=pl,
        example=(request.form.get("example", "") or "").strip(),
        notes=(request.form.get("notes", "") or "").strip(),
        tags=tags,
        created_at=now_iso(),
    )
    words[w.id] = w
    save_words(words)

    flash("Dodano s≈Ç√≥wko ‚úÖ", "ok")
    return redirect(url_for("words_page"))


@app.route("/words")
def words_page():
    words = load_words()
    q = (request.args.get("q", "") or "").strip().lower()
    tag = (request.args.get("tag", "") or "").strip()

    items = list(words.values())
    if q:
        items = [w for w in items if q in w.en.lower() or q in w.pl.lower() or q in (w.example or "").lower()]
    if tag:
        items = [w for w in items if tag in (w.tags or [])]

    items.sort(key=lambda w: w.created_at, reverse=True)
    all_tags = sorted({t for w in words.values() for t in (w.tags or [])})

    def card(w: Word) -> str:
        tags_html = "".join([f'<span class="pill">{t}</span>' for t in (w.tags or [])])
        return f"""
        <div class="card">
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start">
            <div>
              <h3 style="margin:0 0 6px 0">{w.en} {tts_btn(w.en)} <span class="muted">‚Üí</span> {w.pl}</h3>
              <div>{tags_html}</div>
              <div class="muted" style="margin-top:6px">{("Przyk≈Çad: " + w.example) if w.example else ""}</div>
              <div class="muted" style="margin-top:6px">Dodano: {w.created_at or "-"}</div>
              {f'<div class="muted" style="margin-top:8px">{w.notes}</div>' if w.notes else ''}
            </div>
            <div class="actions">
              <a class="btn btn-ghost" href="{url_for('edit_word', wid=w.id)}">Edytuj</a>
              <form method="post" action="{url_for('delete_word', wid=w.id)}" onsubmit="return confirm('UsunƒÖƒá to s≈Ç√≥wko?');">
                <button class="btn" type="submit">Usu≈Ñ</button>
              </form>
            </div>
          </div>
        </div>
        """

    cards = "".join([card(w) for w in items]) if items else '<div class="card muted">Brak wynik√≥w.</div>'
    tags_links = " ".join([f'<a class="pill" href="{url_for("words_page", tag=t)}">{t}</a>' for t in all_tags]) or "<span class='muted'>Brak tag√≥w.</span>"

    body = f"""
    <div class="grid">
      <div class="card">
        <h2>S≈Çownik</h2>
        <form method="get" action="{url_for('words_page')}">
          <div class="row">
            <div><input name="q" value="{q}" placeholder="Szukaj (en/pl/przyk≈Çad)"></div>
            <div>
              <select name="tag">
                <option value="">(filtr tag)</option>
                {''.join([f'<option value="{t}" {"selected" if t==tag else ""}>{t}</option>' for t in all_tags])}
              </select>
            </div>
          </div>
          <div class="actions" style="margin-top:10px">
            <button class="btn" type="submit">Szukaj</button>
            <a class="btn btn-ghost" href="{url_for('words_page')}">Reset</a>
          </div>
        </form>
        <div class="hr"></div>
        <div class="muted">Tagi: {tags_links}</div>
      </div>

      <div class="card">
        <h2>Szybkie akcje</h2>
        <div class="actions">
          <a class="btn" href="{url_for('lessons_list')}">Lekcje</a>
          <a class="btn btn-ghost" href="{url_for('materials_list')}">Materia≈Çy</a>
        </div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="list">{cards}</div>
    """
    return render(body)


@app.route("/words/<wid>/edit", methods=["GET", "POST"])
def edit_word(wid: str):
    words = load_words()
    if wid not in words:
        flash("Nie znaleziono s≈Ç√≥wka.", "err")
        return redirect(url_for("words_page"))

    w = words[wid]
    if request.method == "POST":
        w.en = (request.form.get("en", "") or "").strip()
        w.pl = (request.form.get("pl", "") or "").strip()
        w.example = (request.form.get("example", "") or "").strip()
        w.notes = (request.form.get("notes", "") or "").strip()
        tags_raw = (request.form.get("tags", "") or "").strip()
        w.tags = [t.strip() for t in tags_raw.split(",") if t.strip()] if tags_raw else []

        save_words(words)
        flash("Zapisano zmiany ‚úÖ", "ok")
        return redirect(url_for("words_page"))

    body = f"""
    <div class="card">
      <h2>Edytuj s≈Ç√≥wko: {w.id}</h2>
      <form method="post">
        <div class="row">
          <div>
            <label>Angielski</label>
            <input name="en" value="{w.en}" required>
          </div>
          <div>
            <label>Polski</label>
            <input name="pl" value="{w.pl}" required>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Tagi (po przecinku)</label>
            <input name="tags" value="{', '.join(w.tags or [])}">
          </div>
          <div>
            <label>Przyk≈Çad</label>
            <input name="example" value="{w.example}">
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Notatki</label>
          <textarea name="notes">{w.notes}</textarea>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn" type="submit">Zapisz</button>
          <a class="btn btn-ghost" href="{url_for('words_page')}">Powr√≥t</a>
        </div>
      </form>
    </div>
    """
    return render(body)


@app.route("/words/<wid>/delete", methods=["POST"])
def delete_word(wid: str):
    words = load_words()
    if wid in words:
        del words[wid]
        save_words(words)
        flash("Usuniƒôto s≈Ç√≥wko.", "ok")
    return redirect(url_for("words_page"))


# ----------------------------
# LEKCJE ‚Äì tylko s≈Çownictwo
# ----------------------------

@app.route("/lessons")
def lessons_list():
    words = load_words()

    cards = ""
    for lesson in LESSONS:
        missing = lesson_missing_phrases(words, lesson)
        total_phrases = len(lesson.get("required_phrases", []))
        if not missing:
            status = "‚úÖ Wszystkie zwroty sƒÖ w s≈Çowniku"
        else:
            status = f"‚ö†Ô∏è Brakuje {len(missing)} zwrot√≥w w s≈Çowniku"
        cards += f"""
        <div class="card">
          <h3 style="margin:0 0 6px 0">{lesson['title']} <span class="pill">{lesson['level']}</span></h3>
          <div class="muted">{lesson['goal']}</div>
          <div class="hr"></div>
          <div><b>Status:</b> {status}</div>
          <div class="muted" style="margin-top:4px">Zwrot√≥w w lekcji: <b>{total_phrases}</b></div>
          <div class="actions" style="margin-top:10px">
            <a class="btn" href="{url_for('lesson_view', lesson_id=lesson['id'])}">Otw√≥rz lekcjƒô</a>
            <a class="btn btn-ghost" href="{url_for('words_page')}">S≈Çownik</a>
          </div>
        </div>
        """

    body = f"""
    <div class="card">
      <h2>Lekcje</h2>
      <p class="muted">
        Ka≈ºda lekcja to lista gotowych zwrot√≥w.
        <br><b>Status</b> pokazuje, czy wszystkie wyra≈ºenia masz ju≈º w swoim s≈Çowniku.
      </p>
      <p class="muted" style="margin-top:6px">
        Przy ka≈ºdej frazie jest przycisk üîä z wymowƒÖ (brytyjski angielski ‚Äì je≈õli dostƒôpny w przeglƒÖdarce).
      </p>
    </div>
    <div class="hr"></div>
    <div class="list">{cards}</div>
    """
    return render(body)


@app.route("/lesson/<int:lesson_id>")
def lesson_view(lesson_id: int):
    lesson = next((l for l in LESSONS if l["id"] == lesson_id), None)
    if not lesson:
        flash("Nie ma takiej lekcji.", "err")
        return redirect(url_for("lessons_list"))

    words = load_words()
    missing = lesson_missing_phrases(words, lesson)
    total_phrases = len(lesson.get("required_phrases", []))

    if missing:
        status = "‚ö†Ô∏è Brakuje zwrot√≥w w s≈Çowniku"
        info_html = """
        <p class="muted">
          Poni≈ºej widaƒá wszystkie zwroty lekcji. Te, kt√≥rych nie masz jeszcze w s≈Çowniku,
          <b>dodaj rƒôcznie</b> z poziomu strony g≈Ç√≥wnej (Start).
        </p>
        """
    else:
        status = "‚úÖ Wszystkie zwroty sƒÖ w s≈Çowniku"
        info_html = """
        <p class="muted">
          Wszystkie zwroty z tej lekcji sƒÖ ju≈º w Twoim s≈Çowniku. Mo≈ºesz je ƒáwiczyƒá,
          u≈ºywajƒÖc tylko üîä wymowy i w≈Çasnych notatek.
        </p>
        """

    phrases_html = ""
    for rp in lesson["required_phrases"]:
        phrases_html += f"""
        <div class="card">
          <b>{rp['en']}</b> {tts_btn(rp['en'])}
          <div class="muted">‚Üí {rp['pl']}</div>
        </div>
        """

    body = f"""
    <div class="card">
      <h2>{lesson['title']}</h2>
      <p class="muted">{lesson['goal']}</p>
      <div class="hr"></div>
      <p><b>Status:</b> {status}</p>
      <p class="muted">Zwrot√≥w w lekcji: <b>{total_phrases}</b></p>
      {info_html}
      <div class="actions" style="margin-top:10px">
        <a class="btn btn-ghost" href="{url_for('lessons_list')}">Wr√≥ƒá do lekcji</a>
        <a class="btn btn-ghost" href="{url_for('words_page')}">Otw√≥rz s≈Çownik</a>
      </div>
    </div>

    <div class="hr"></div>

    <h3>Zwroty z tej lekcji</h3>
    <div class="list">
      {phrases_html}
    </div>
    """
    return render(body)


# ============================
# START APP
# ============================

if __name__ == "__main__":
    app.run(host="127.0.0.1", port=5000, debug=True)
