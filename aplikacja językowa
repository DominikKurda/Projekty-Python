from __future__ import annotations

import json
import os
import random
import html as html_escape
from dataclasses import dataclass, asdict
from datetime import datetime, timedelta
from typing import Dict, List

from flask import Flask, request, redirect, url_for, flash, render_template_string

APP_TITLE = "English Trainer (Flask)"
DATA_FILE = "words.json"
LESSONS_FILE = "lessons_progress.json"

app = Flask(__name__)
app.secret_key = "change-me-please"  # zmieÅ„ na coÅ› wÅ‚asnego


# ============================
# Model sÅ‚Ã³wka + zapis do JSON
# ============================

@dataclass
class Word:
    id: str
    en: str
    pl: str
    example: str = ""
    notes: str = ""
    tags: List[str] = None

    # SRS / powtÃ³rki
    next_review: str = ""  # ISO datetime
    interval_days: int = 0
    ease: float = 2.5
    reps: int = 0

    # statystyki
    correct: int = 0
    wrong: int = 0
    created_at: str = ""

    def to_dict(self) -> dict:
        d = asdict(self)
        d["tags"] = self.tags or []
        return d

    @staticmethod
    def from_dict(d: dict) -> "Word":
        return Word(
            id=d.get("id", ""),
            en=(d.get("en", "") or "").strip(),
            pl=(d.get("pl", "") or "").strip(),
            example=d.get("example", "") or "",
            notes=d.get("notes", "") or "",
            tags=d.get("tags", []) or [],
            next_review=d.get("next_review", "") or "",
            interval_days=int(d.get("interval_days", 0) or 0),
            ease=float(d.get("ease", 2.5) or 2.5),
            reps=int(d.get("reps", 0) or 0),
            correct=int(d.get("correct", 0) or 0),
            wrong=int(d.get("wrong", 0) or 0),
            created_at=d.get("created_at", "") or "",
        )


def now_iso() -> str:
    return datetime.now().isoformat(timespec="seconds")


def parse_iso(s: str) -> datetime:
    if not s:
        return datetime.now()
    try:
        return datetime.fromisoformat(s)
    except Exception:
        return datetime.now()


def load_words() -> Dict[str, Word]:
    if not os.path.exists(DATA_FILE):
        seed = seed_words()
        save_words(seed)
        return seed

    with open(DATA_FILE, "r", encoding="utf-8") as f:
        raw = json.load(f)

    words: Dict[str, Word] = {}
    for item in raw.get("words", []):
        w = Word.from_dict(item)
        if w.id:
            words[w.id] = w
    return words


def save_words(words: Dict[str, Word]) -> None:
    payload = {"words": [w.to_dict() for w in words.values()]}
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(payload, f, ensure_ascii=False, indent=2)


def seed_words() -> Dict[str, Word]:
    # PrzykÅ‚adowa baza startowa â€“ moÅ¼esz zresetowaÄ‡ w Settings
    base = [
        # lesson1
        ("Hi!", "CzeÅ›Ä‡!", "Hi! My name is Tom.", ["lesson1", "everyday"]),
        ("Hello!", "Witaj! / DzieÅ„ dobry!", "Hello! Nice to meet you.", ["lesson1", "everyday"]),
        ("My name is ...", "Mam na imiÄ™ ...", "My name is Anna.", ["lesson1"]),
        ("What's your name?", "Jak masz na imiÄ™?", "What's your name?", ["lesson1"]),
        ("Nice to meet you.", "MiÅ‚o mi ciÄ™ poznaÄ‡.", "Nice to meet you.", ["lesson1"]),
        ("How are you?", "Jak siÄ™ masz?", "How are you today?", ["lesson1"]),
        ("I'm fine, thanks.", "W porzÄ…dku, dziÄ™ki.", "I'm fine, thanks.", ["lesson1"]),
        ("Where are you from?", "SkÄ…d jesteÅ›?", "Where are you from?", ["lesson1"]),
        ("I'm from Poland.", "Jestem z Polski.", "I'm from Poland.", ["lesson1"]),
        ("Goodbye!", "Do widzenia!", "Goodbye! See you.", ["lesson1"]),

        # lesson2
        ("How old are you?", "Ile masz lat?", "How old are you?", ["lesson2"]),
        ("I'm ... years old.", "Mam ... lat.", "I'm 25 years old.", ["lesson2"]),
        ("I was born in ...", "UrodziÅ‚em/am siÄ™ w ...", "I was born in 2000.", ["lesson2"]),
        ("When were you born?", "Kiedy siÄ™ urodziÅ‚eÅ›/urodziÅ‚aÅ›?", "When were you born?", ["lesson2"]),
        ("I'm a student.", "Jestem studentem/studentkÄ….", "I'm a student.", ["lesson2"]),
        ("I work as a ...", "PracujÄ™ jako ...", "I work as a programmer.", ["lesson2"]),
        ("What do you do?", "Czym siÄ™ zajmujesz?", "What do you do?", ["lesson2"]),
        ("I live in ...", "Mieszkam w ...", "I live in KrakÃ³w.", ["lesson2"]),
        ("That's interesting.", "To ciekawe.", "That's interesting.", ["lesson2"]),

        # Airport module (tags)
        ("Iâ€™d like to check in, please.", "ChciaÅ‚bym siÄ™ odprawiÄ‡.", "", ["airport", "lesson31"]),
        ("Here is my passport and ticket.", "Oto paszport i bilet.", "", ["airport", "lesson31"]),
        ("I have a reservation.", "Mam rezerwacjÄ™.", "", ["airport", "lesson31"]),
        ("I have luggage to check in.", "Mam bagaÅ¼ do nadania.", "", ["airport", "lesson31"]),
        ("I have only hand luggage.", "Mam tylko bagaÅ¼ podrÄ™czny.", "", ["airport", "lesson31"]),
        ("Can I have a window seat?", "Czy mogÄ™ dostaÄ‡ miejsce przy oknie?", "", ["airport", "lesson31"]),
        ("Can I have an aisle seat?", "Czy mogÄ™ dostaÄ‡ miejsce przy przejÅ›ciu?", "", ["airport", "lesson31"]),
        ("Is the flight on time?", "Czy lot jest punktualny?", "", ["airport", "lesson31"]),
    ]

    words: Dict[str, Word] = {}
    for i, (en, pl, ex, tags) in enumerate(base, start=1):
        wid = f"w{i:04d}"
        w = Word(
            id=wid,
            en=en,
            pl=pl,
            example=ex,
            notes="",
            tags=tags,
            created_at=now_iso(),
            next_review=now_iso(),
            interval_days=0,
            ease=2.5,
            reps=0,
        )
        words[w.id] = w
    return words


# ============================
# SRS (powtÃ³rki) â€“ prosty SM-2
# ============================

def schedule_next(word: Word, grade: int) -> None:
    word.ease = max(1.3, word.ease + (0.1 - (5 - grade) * (0.08 + (5 - grade) * 0.02)))

    if grade < 3:
        word.reps = 0
        word.interval_days = 1
    else:
        word.reps += 1
        if word.reps == 1:
            word.interval_days = 1
        elif word.reps == 2:
            word.interval_days = 3
        else:
            word.interval_days = int(round(word.interval_days * word.ease))

    next_dt = datetime.now() + timedelta(days=word.interval_days)
    word.next_review = next_dt.isoformat(timespec="seconds")


def due_words(words: Dict[str, Word], tag: str = "") -> List[Word]:
    now = datetime.now()
    items = list(words.values())
    if tag:
        items = [w for w in items if tag in (w.tags or [])]
    return [w for w in items if parse_iso(w.next_review) <= now]


# ============================
# TTS helpers (ğŸ”Š)
# ============================

def tts_btn(text: str, size: str = "sm") -> str:
    safe = html_escape.escape(text or "", quote=True)
    cls = "tts-btn tts-sm" if size == "sm" else "tts-btn"
    return f'<button type="button" class="{cls}" data-tts="{safe}" title="OdsÅ‚uchaj">ğŸ”Š</button>'


# ============================
# MateriaÅ‚y (teoria/gramatyka)
# + dodane przymiotniki
# ============================

MATERIALS = [
    {
        "id": "past_to_be",
        "title": "Czas przeszÅ‚y â€“ TO BE (was / were)",
        "sections": [
            {
                "title": "Forma twierdzÄ…ca",
                "items": [
                    {"en": "I was", "pl": "ja byÅ‚em / ja byÅ‚am"},
                    {"en": "you were", "pl": "ty byÅ‚eÅ› / ty byÅ‚aÅ›"},
                    {"en": "he was", "pl": "on byÅ‚"},
                    {"en": "she was", "pl": "ona byÅ‚a"},
                    {"en": "it was", "pl": "to byÅ‚o"},
                    {"en": "we were", "pl": "my byliÅ›my / my byÅ‚yÅ›my"},
                    {"en": "you were", "pl": "wy byliÅ›cie / wy byÅ‚yÅ›cie"},
                    {"en": "they were", "pl": "oni byli / one byÅ‚y"},
                ],
            },
            {
                "title": "Forma przeczÄ…ca",
                "items": [
                    {"en": "I wasnâ€™t", "pl": "ja nie byÅ‚em / ja nie byÅ‚am"},
                    {"en": "you werenâ€™t", "pl": "ty nie byÅ‚eÅ› / ty nie byÅ‚aÅ›"},
                    {"en": "he wasnâ€™t", "pl": "on nie byÅ‚"},
                    {"en": "she wasnâ€™t", "pl": "ona nie byÅ‚a"},
                    {"en": "it wasnâ€™t", "pl": "to nie byÅ‚o"},
                    {"en": "we werenâ€™t", "pl": "my nie byliÅ›my / my nie byÅ‚yÅ›my"},
                    {"en": "you werenâ€™t", "pl": "wy nie byliÅ›cie / wy nie byÅ‚yÅ›cie"},
                    {"en": "they werenâ€™t", "pl": "oni nie byli / one nie byÅ‚y"},
                ],
            },
            {
                "title": "W skrÃ³cie",
                "items": [
                    {"en": "was â†’ I / he / she / it", "pl": "was uÅ¼ywamy z: I / he / she / it"},
                    {"en": "were â†’ you / we / they", "pl": "were uÅ¼ywamy z: you / we / they"},
                    {"en": "was not = wasnâ€™t", "pl": "skrÃ³cona forma"},
                    {"en": "were not = werenâ€™t", "pl": "skrÃ³cona forma"},
                ],
            },
        ],
        "examples": [
            {"en": "I was at home yesterday.", "pl": "ByÅ‚em / byÅ‚am wczoraj w domu."},
            {"en": "She wasnâ€™t happy.", "pl": "Ona nie byÅ‚a szczÄ™Å›liwa."},
            {"en": "We were tired after work.", "pl": "ByliÅ›my zmÄ™czeni po pracy."},
            {"en": "They werenâ€™t at the airport.", "pl": "Oni nie byli na lotnisku."},
        ],
    },
    {
        "id": "adjectives_pack",
        "title": "Przymiotniki â€“ zestaw (A1/A2) + wymowa",
        "sections": [
            {
                "title": "Lista",
                "items": [
                    {"en": "cheap", "pl": "tani"},
                    {"en": "expensive", "pl": "drogi"},
                    {"en": "boring", "pl": "nudny"},
                    {"en": "bored", "pl": "znudzony"},
                    {"en": "sad", "pl": "smutny"},
                    {"en": "famous", "pl": "sÅ‚awny (wymowa: /ËˆfeÉªmÉ™s/ â€fejmesâ€)"},
                    {"en": "light", "pl": "jasny / lekki (kontekst)"},
                    {"en": "awful", "pl": "okropny"},
                    {"en": "smart", "pl": "mÄ…dry / inteligentny"},
                    {"en": "clever", "pl": "sprytny"},
                    {"en": "surprised", "pl": "zaskoczony"},
                    {"en": "heavy", "pl": "ciÄ™Å¼ki"},
                    {"en": "dirty", "pl": "brudny (wymowa: â€dirdiâ€)"},
                    {"en": "clean", "pl": "czysty"},
                    {"en": "quiet", "pl": "cichy"},
                    {"en": "modern", "pl": "nowoczesny"},
                    {"en": "old-fashioned", "pl": "staromodny"},
                    {"en": "angry", "pl": "zÅ‚y"},
                    {"en": "worried", "pl": "zmartwiony"},
                    {"en": "nervous", "pl": "zdenerwowany"},
                    {"en": "confident", "pl": "pewny siebie"},
                    {"en": "excited", "pl": "podekscytowany"},
                ],
            }
        ],
        "examples": [
            {"en": "This phone is cheap.", "pl": "Ten telefon jest tani."},
            {"en": "Iâ€™m bored.", "pl": "NudzÄ™ siÄ™ / jestem znudzony."},
            {"en": "She is confident.", "pl": "Ona jest pewna siebie."},
        ],
    },
]


# ============================
# LEKCJE (zostawione jak u Ciebie)
# ============================

def norm(s: str) -> str:
    s = (s or "").strip().lower()
    for ch in ["!", ".", ",", "?", ";", ":", "â€™", "'", "â€¦", "â€“", "â€”"]:
        s = s.replace(ch, "")
    s = " ".join(s.split())
    return s


# --- Twoje LESSONS (wkleiÅ‚em to, co podaÅ‚eÅ›; nie zmieniaÅ‚em treÅ›ci) ---
LESSONS = [
    # -------------------- 1 --------------------
    {
        "id": 1,
        "title": "Lekcja 1: Podstawowe zwroty â€“ przedstawianie siÄ™",
        "level": "A1",
        "goal": "Umiesz siÄ™ przywitaÄ‡, przedstawiÄ‡ i zapytaÄ‡ o imiÄ™.",
        "required_phrases": [
            {"en": "Hi!", "pl": "CzeÅ›Ä‡!"},
            {"en": "Hello!", "pl": "Witaj! / DzieÅ„ dobry!"},
            {"en": "My name is ...", "pl": "Mam na imiÄ™ ..."},
            {"en": "What's your name?", "pl": "Jak masz na imiÄ™?"},
            {"en": "Nice to meet you.", "pl": "MiÅ‚o mi ciÄ™ poznaÄ‡."},
            {"en": "How are you?", "pl": "Jak siÄ™ masz?"},
            {"en": "I'm fine, thanks.", "pl": "W porzÄ…dku, dziÄ™ki."},
            {"en": "Where are you from?", "pl": "SkÄ…d jesteÅ›?"},
            {"en": "I'm from Poland.", "pl": "Jestem z Polski."},
            {"en": "Goodbye!", "pl": "Do widzenia!"},
        ],
        "dialog": [
            {"spk": "A", "en": "Hi! My name is Tom. What's your name?", "pl": "CzeÅ›Ä‡! Mam na imiÄ™ Tom. Jak masz na imiÄ™?"},
            {"spk": "B", "en": "Hello! I'm Anna. Nice to meet you.", "pl": "Witaj! Jestem Anna. MiÅ‚o mi ciÄ™ poznaÄ‡."},
            {"spk": "A", "en": "Nice to meet you too. How are you?", "pl": "MiÅ‚o mi rÃ³wnieÅ¼. Jak siÄ™ masz?"},
            {"spk": "B", "en": "I'm fine, thanks. Where are you from?", "pl": "W porzÄ…dku, dziÄ™ki. SkÄ…d jesteÅ›?"},
            {"spk": "A", "en": "I'm from Poland. Goodbye!", "pl": "Jestem z Polski. Do widzenia!"},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zwroty (EN â†’ PL)",
                "items": [
                    {"en": "What's your name?", "pl": "Jak masz na imiÄ™?"},
                    {"en": "Nice to meet you.", "pl": "MiÅ‚o mi ciÄ™ poznaÄ‡."},
                    {"en": "Where are you from?", "pl": "SkÄ…d jesteÅ›?"},
                    {"en": "I'm fine, thanks.", "pl": "W porzÄ…dku, dziÄ™ki."},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "My ____ is Anna.", "answer": "name", "hint": "name = imiÄ™"},
                    {"sentence": "Nice to ____ you.", "answer": "meet", "hint": "meet = poznaÄ‡"},
                    {"sentence": "Where are you ____?", "answer": "from", "hint": "from = z"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak powiesz â€Jak masz na imiÄ™?â€ po angielsku?", "a": "What's your name?"},
                    {"q": "Jak powiesz â€MiÅ‚o mi ciÄ™ poznaÄ‡.â€ po angielsku?", "a": "Nice to meet you."},
                ],
            },
        ],
    },

    # -------------------- 2 --------------------
    {
        "id": 2,
        "title": "Lekcja 2: Ile masz lat? â€“ wiek, data urodzenia i zajÄ™cie",
        "level": "A1/A2",
        "goal": "Umiesz zapytaÄ‡ o wiek, powiedzieÄ‡ ile masz lat i czym siÄ™ zajmujesz.",
        "required_phrases": [
            {"en": "How old are you?", "pl": "Ile masz lat?"},
            {"en": "I'm ... years old.", "pl": "Mam ... lat."},
            {"en": "When were you born?", "pl": "Kiedy siÄ™ urodziÅ‚eÅ›/urodziÅ‚aÅ›?"},
            {"en": "I was born in ...", "pl": "UrodziÅ‚em/am siÄ™ w ..."},
            {"en": "What do you do?", "pl": "Czym siÄ™ zajmujesz?"},
            {"en": "I'm a student.", "pl": "Jestem studentem/studentkÄ…."},
            {"en": "I work as a ...", "pl": "PracujÄ™ jako ..."},
            {"en": "I live in ...", "pl": "Mieszkam w ..."},
            {"en": "That's interesting.", "pl": "To ciekawe."},
        ],
        "dialog": [
            {"spk": "A", "en": "Hi! How old are you?", "pl": "CzeÅ›Ä‡! Ile masz lat?"},
            {"spk": "B", "en": "I'm 25 years old. What about you?", "pl": "Mam 25 lat. A ty?"},
            {"spk": "A", "en": "I'm 30. When were you born?", "pl": "Mam 30. Kiedy siÄ™ urodziÅ‚eÅ›/urodziÅ‚aÅ›?"},
            {"spk": "B", "en": "I was born in 2000. What do you do?", "pl": "UrodziÅ‚em/am siÄ™ w 2000 roku. Czym siÄ™ zajmujesz?"},
            {"spk": "A", "en": "I work as a programmer. I live in Warsaw.", "pl": "PracujÄ™ jako programista. Mieszkam w Warszawie."},
            {"spk": "B", "en": "That's interesting!", "pl": "To ciekawe!"},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zwroty (EN â†’ PL)",
                "items": [
                    {"en": "How old are you?", "pl": "Ile masz lat?"},
                    {"en": "When were you born?", "pl": "Kiedy siÄ™ urodziÅ‚eÅ›/urodziÅ‚aÅ›?"},
                    {"en": "What do you do?", "pl": "Czym siÄ™ zajmujesz?"},
                    {"en": "That's interesting.", "pl": "To ciekawe."},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "I'm 20 ____ old.", "answer": "years", "hint": "years = lat"},
                    {"sentence": "I was ____ in 1999.", "answer": "born", "hint": "born = urodzony"},
                    {"sentence": "I ____ as a teacher.", "answer": "work", "hint": "work = pracowaÄ‡"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak powiesz â€Mam 18 lat.â€ po angielsku?", "a": "I'm 18 years old."},
                    {"q": "Jak powiesz â€UrodziÅ‚em/am siÄ™ w 2005.â€ po angielsku?", "a": "I was born in 2005."},
                ],
            },
        ],
    },

    # -------------------- 2.1 (21) --------------------
    {
        "id": 21,
        "title": "Lekcja 2.1: Opis o sobie â€“ Dominik (A1/A2)",
        "level": "A1/A2",
        "goal": "Umiesz krÃ³tko opisaÄ‡ siebie: imiÄ™, wiek, zawÃ³d, miejsce i wyglÄ…d.",
        "required_phrases": [
            {"en": "My name is Dominik.", "pl": "Mam na imiÄ™ Dominik."},
            {"en": "I am 22 years old.", "pl": "Mam 22 lata."},
            {"en": "I am a software tester in IT.", "pl": "Jestem testerem oprogramowania w IT."},
            {"en": "I live in Bzinica Stara in Poland.", "pl": "Mieszkam w Bzinicy Starej w Polsce."},
            {"en": "I have got blue eyes.", "pl": "Mam niebieskie oczy."},
            {"en": "I have got brown hair.", "pl": "Mam brÄ…zowe wÅ‚osy."},
            {"en": "I have got a light face.", "pl": "Mam jasnÄ… twarz."},
            {"en": "I have got a short beard.", "pl": "Mam krÃ³tkÄ… brodÄ™."},
            {"en": "I wear glasses.", "pl": "NoszÄ™ okulary."},
        ],
        "dialog": [
            {
                "spk": "TEXT",
                "en": "My name is Dominik. I am 22 years old. I am a software tester in IT. "
                      "I live in Bzinica Stara in Poland. I have got blue eyes and brown hair. "
                      "I have got a light face and a short beard. I wear glasses.",
                "pl": "Mam na imiÄ™ Dominik. Mam 22 lata. Jestem testerem oprogramowania w IT. "
                      "Mieszkam w Bzinicy Starej w Polsce. Mam niebieskie oczy i brÄ…zowe wÅ‚osy. "
                      "Mam jasnÄ… twarz i krÃ³tkÄ… brodÄ™. NoszÄ™ okulary.",
            }
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zdania (EN â†’ PL)",
                "items": [
                    {"en": "My name is Dominik.", "pl": "Mam na imiÄ™ Dominik."},
                    {"en": "I am 22 years old.", "pl": "Mam 22 lata."},
                    {"en": "I wear glasses.", "pl": "NoszÄ™ okulary."},
                    {"en": "I have got brown hair.", "pl": "Mam brÄ…zowe wÅ‚osy."},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "My ____ is Dominik.", "answer": "name", "hint": "name = imiÄ™"},
                    {"sentence": "I am 22 ____ old.", "answer": "years", "hint": "years old = lat"},
                    {"sentence": "I ____ in Bzinica Stara in Poland.", "answer": "live", "hint": "live = mieszkaÄ‡"},
                    {"sentence": "I have got ____ eyes.", "answer": "blue", "hint": "blue = niebieskie"},
                    {"sentence": "I wear ____.", "answer": "glasses", "hint": "glasses = okulary"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak powiesz â€Jestem testerem oprogramowania w IT.â€ po angielsku?", "a": "I am a software tester in IT."},
                    {"q": "Jak powiesz â€Mam krÃ³tkÄ… brodÄ™.â€ po angielsku?", "a": "I have got a short beard."},
                    {"q": "Jak powiesz â€Mieszkam w Bzinicy Starej w Polsce.â€ po angielsku?", "a": "I live in Bzinica Stara in Poland."},
                ],
            },
        ],
    },

    # -------------------- 3.1 --------------------
    {
        "id": 31,
        "title": "Lekcja 3.1: Lotnisko â€“ Odprawa / Check-in (PasaÅ¼er)",
        "level": "A1/A2",
        "goal": "Umiesz przejÅ›Ä‡ odprawÄ™: check-in, dokumenty, bagaÅ¼, miejsce i punktualnoÅ›Ä‡.",
        "required_phrases": [
            {"en": "Iâ€™d like to check in, please.", "pl": "ChciaÅ‚bym siÄ™ odprawiÄ‡."},
            {"en": "Here is my passport and ticket.", "pl": "Oto paszport i bilet."},
            {"en": "I have a reservation.", "pl": "Mam rezerwacjÄ™."},
            {"en": "I have luggage to check in.", "pl": "Mam bagaÅ¼ do nadania."},
            {"en": "I have only hand luggage.", "pl": "Mam tylko bagaÅ¼ podrÄ™czny."},
            {"en": "Can I have a window seat?", "pl": "Czy mogÄ™ dostaÄ‡ miejsce przy oknie?"},
            {"en": "Can I have an aisle seat?", "pl": "Czy mogÄ™ dostaÄ‡ miejsce przy przejÅ›ciu?"},
            {"en": "Is the flight on time?", "pl": "Czy lot jest punktualny?"},
        ],
        "dialog": [
            {"spk": "Passenger", "en": "Iâ€™d like to check in, please.", "pl": "ChciaÅ‚bym siÄ™ odprawiÄ‡."},
            {"spk": "Agent", "en": "Sure. Do you have a reservation?", "pl": "OczywiÅ›cie. Czy ma Pan/Pani rezerwacjÄ™?"},
            {"spk": "Passenger", "en": "I have a reservation. Here is my passport and ticket.", "pl": "Mam rezerwacjÄ™. Oto paszport i bilet."},
            {"spk": "Agent", "en": "Do you have luggage to check in?", "pl": "Czy ma Pan/Pani bagaÅ¼ do nadania?"},
            {"spk": "Passenger", "en": "I have luggage to check in.", "pl": "Mam bagaÅ¼ do nadania."},
            {"spk": "Passenger", "en": "Can I have a window seat?", "pl": "Czy mogÄ™ dostaÄ‡ miejsce przy oknie?"},
            {"spk": "Agent", "en": "Yes. The flight is on time.", "pl": "Tak. Lot jest punktualny."},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zwroty (EN â†’ PL)",
                "items": [
                    {"en": "Iâ€™d like to check in, please.", "pl": "ChciaÅ‚bym siÄ™ odprawiÄ‡."},
                    {"en": "Here is my passport and ticket.", "pl": "Oto paszport i bilet."},
                    {"en": "I have only hand luggage.", "pl": "Mam tylko bagaÅ¼ podrÄ™czny."},
                    {"en": "Is the flight on time?", "pl": "Czy lot jest punktualny?"},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "Iâ€™d like to ____ in, please.", "answer": "check", "hint": "check in = odprawiÄ‡ siÄ™"},
                    {"sentence": "Here is my passport and ____.", "answer": "ticket", "hint": "ticket = bilet"},
                    {"sentence": "Can I have a ____ seat?", "answer": "window", "hint": "window seat = miejsce przy oknie"},
                    {"sentence": "Is the flight on ____?", "answer": "time", "hint": "on time = punktualnie"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak powiesz â€Mam bagaÅ¼ do nadaniaâ€ po angielsku?", "a": "I have luggage to check in."},
                    {"q": "Jak powiesz â€Czy lot jest punktualny?â€ po angielsku?", "a": "Is the flight on time?"},
                ],
            },
        ],
    },
{
        "id": 32,
        "title": "Lekcja 3.2: Lotnisko â€“ Odprawa / Check-in (ObsÅ‚uga)",
        "level": "A1/A2",
        "goal": "Rozumiesz pytania obsÅ‚ugi podczas odprawy.",
        "required_phrases": [
            {"en": "May I see your passport?", "pl": "Czy mogÄ™ zobaczyÄ‡ paszport?"},
            {"en": "How many bags are you checking in?", "pl": "Ile bagaÅ¼y nadajesz?"},
            {"en": "Here is your boarding pass.", "pl": "Oto karta pokÅ‚adowa."},
        ],
        "dialog": [
            {"spk": "Agent", "en": "Good morning. May I see your passport?", "pl": "DzieÅ„ dobry. Czy mogÄ™ zobaczyÄ‡ paszport?"},
            {"spk": "Passenger", "en": "Of course. Here you are.", "pl": "OczywiÅ›cie. ProszÄ™ bardzo."},
            {"spk": "Agent", "en": "How many bags are you checking in?", "pl": "Ile bagaÅ¼y nadajesz?"},
            {"spk": "Passenger", "en": "One bag, please.", "pl": "Jeden bagaÅ¼, proszÄ™."},
            {"spk": "Agent", "en": "Here is your boarding pass.", "pl": "Oto karta pokÅ‚adowa."},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zwroty (EN â†’ PL)",
                "items": [
                    {"en": "May I see your passport?", "pl": "Czy mogÄ™ zobaczyÄ‡ paszport?"},
                    {"en": "How many bags are you checking in?", "pl": "Ile bagaÅ¼y nadajesz?"},
                    {"en": "Here is your boarding pass.", "pl": "Oto karta pokÅ‚adowa."},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "May I ____ your passport?", "answer": "see", "hint": "see = widzieÄ‡"},
                    {"sentence": "How many ____ are you checking in?", "answer": "bags", "hint": "bags = bagaÅ¼e"},
                    {"sentence": "Here is your ____ pass.", "answer": "boarding", "hint": "boarding pass = karta pokÅ‚adowa"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak obsÅ‚uga powie â€Czy mogÄ™ zobaczyÄ‡ paszport?â€ po angielsku?", "a": "May I see your passport?"},
                    {"q": "Jak obsÅ‚uga powie â€Oto karta pokÅ‚adowa.â€ po angielsku?", "a": "Here is your boarding pass."},
                ],
            },
        ],
    },

    {
        "id": 33,
        "title": "Lekcja 3.3: Lotnisko â€“ BagaÅ¼ (Baggage)",
        "level": "A1/A2",
        "goal": "Znasz podstawowe sÅ‚ownictwo dotyczÄ…ce bagaÅ¼u na lotnisku.",
        "required_phrases": [
            {"en": "checked baggage", "pl": "bagaÅ¼ rejestrowany"},
            {"en": "carry-on baggage", "pl": "bagaÅ¼ podrÄ™czny"},
            {"en": "hand luggage", "pl": "bagaÅ¼ podrÄ™czny"},
            {"en": "overweight baggage", "pl": "bagaÅ¼ z nadwagÄ…"},
            {"en": "fragile", "pl": "delikatny"},
            {"en": "lost luggage", "pl": "zagubiony bagaÅ¼"},
        ],
        "dialog": [
            {"spk": "Agent", "en": "Do you have any checked baggage?", "pl": "Czy ma Pan/Pani bagaÅ¼ rejestrowany?"},
            {"spk": "Passenger", "en": "Yes, I have one checked baggage.", "pl": "Tak, mam jeden bagaÅ¼ rejestrowany."},
            {"spk": "Agent", "en": "Is your bag fragile?", "pl": "Czy bagaÅ¼ jest delikatny?"},
            {"spk": "Passenger", "en": "Yes, it is fragile.", "pl": "Tak, jest delikatny."},
            {"spk": "Agent", "en": "Your baggage is overweight.", "pl": "Pana/Pani bagaÅ¼ ma nadwagÄ™."},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj sÅ‚owa (EN â†’ PL)",
                "items": [
                    {"en": "checked baggage", "pl": "bagaÅ¼ rejestrowany"},
                    {"en": "hand luggage", "pl": "bagaÅ¼ podrÄ™czny"},
                    {"en": "overweight baggage", "pl": "bagaÅ¼ z nadwagÄ…"},
                    {"en": "lost luggage", "pl": "zagubiony bagaÅ¼"},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "This is my ____ baggage.", "answer": "checked", "hint": "checked baggage = rejestrowany"},
                    {"sentence": "My baggage is ____.", "answer": "overweight", "hint": "overweight = z nadwagÄ…"},
                    {"sentence": "The bag is ____.", "answer": "fragile", "hint": "fragile = delikatny"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak powiesz â€zagubiony bagaÅ¼â€ po angielsku?", "a": "lost luggage"},
                    {"q": "Jak powiesz â€bagaÅ¼ podrÄ™cznyâ€ po angielsku?", "a": "hand luggage"},
                ],
            },
        ],
    },

    {
        "id": 34,
        "title": "Lekcja 3.4: Lotnisko â€“ Kontrola bezpieczeÅ„stwa (Security)",
        "level": "A1/A2",
        "goal": "Rozumiesz polecenia i pytania obsÅ‚ugi podczas kontroli bezpieczeÅ„stwa.",
        "required_phrases": [
            {"en": "Please remove your shoes.", "pl": "ProszÄ™ zdjÄ…Ä‡ buty."},
            {"en": "Take your laptop out of the bag.", "pl": "Wyjmij laptopa z torby."},
            {"en": "Put your liquids in the tray.", "pl": "WÅ‚Ã³Å¼ pÅ‚yny do pojemnika."},
            {"en": "Walk through the scanner.", "pl": "PrzejdÅº przez skaner."},
            {"en": "Do you have any liquids?", "pl": "Czy masz jakieÅ› pÅ‚yny?"},
        ],
        "dialog": [
            {"spk": "Officer", "en": "Please remove your shoes.", "pl": "ProszÄ™ zdjÄ…Ä‡ buty."},
            {"spk": "Officer", "en": "Do you have any liquids?", "pl": "Czy masz jakieÅ› pÅ‚yny?"},
            {"spk": "Passenger", "en": "Yes, I have liquids in my bag.", "pl": "Tak, mam pÅ‚yny w torbie."},
            {"spk": "Officer", "en": "Put your liquids in the tray.", "pl": "WÅ‚Ã³Å¼ pÅ‚yny do pojemnika."},
            {"spk": "Officer", "en": "Take your laptop out of the bag.", "pl": "Wyjmij laptopa z torby."},
            {"spk": "Officer", "en": "Walk through the scanner.", "pl": "PrzejdÅº przez skaner."},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj polecenia (EN â†’ PL)",
                "items": [
                    {"en": "Please remove your shoes.", "pl": "ProszÄ™ zdjÄ…Ä‡ buty."},
                    {"en": "Put your liquids in the tray.", "pl": "WÅ‚Ã³Å¼ pÅ‚yny do pojemnika."},
                    {"en": "Walk through the scanner.", "pl": "PrzejdÅº przez skaner."},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "Please remove your ____.", "answer": "shoes", "hint": "shoes = buty"},
                    {"sentence": "Put your ____ in the tray.", "answer": "liquids", "hint": "liquids = pÅ‚yny"},
                    {"sentence": "Walk ____ the scanner.", "answer": "through", "hint": "through = przez"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak obsÅ‚uga powie â€Wyjmij laptopa z torbyâ€ po angielsku?", "a": "Take your laptop out of the bag."},
                    {"q": "Jak obsÅ‚uga zapyta â€Czy masz jakieÅ› pÅ‚yny?â€ po angielsku?", "a": "Do you have any liquids?"},
                ],
            },
        ],
    },

    {
        "id": 35,
        "title": "Lekcja 3.5: Lotnisko â€“ Kontrola paszportowa (Passport Control)",
        "level": "A1/A2",
        "goal": "Potrafisz odpowiedzieÄ‡: cel podrÃ³Å¼y, czas pobytu, miejsce zakwaterowania.",
        "required_phrases": [
            {"en": "What is the purpose of your visit?", "pl": "Jaki jest cel wizyty?"},
            {"en": "Tourism", "pl": "Turystyka"},
            {"en": "Business", "pl": "Biznes"},
            {"en": "Work", "pl": "Praca"},
            {"en": "How long are you staying?", "pl": "Jak dÅ‚ugo zostajesz?"},
            {"en": "Where will you stay?", "pl": "Gdzie bÄ™dziesz mieszkaÄ‡?"},
        ],
        "dialog": [
            {"spk": "Officer", "en": "What is the purpose of your visit?", "pl": "Jaki jest cel wizyty?"},
            {"spk": "Passenger", "en": "Tourism.", "pl": "Turystyka."},
            {"spk": "Officer", "en": "How long are you staying?", "pl": "Jak dÅ‚ugo zostajesz?"},
            {"spk": "Passenger", "en": "I am staying for one week.", "pl": "ZostajÄ™ na jeden tydzieÅ„."},
            {"spk": "Officer", "en": "Where will you stay?", "pl": "Gdzie bÄ™dziesz mieszkaÄ‡?"},
            {"spk": "Passenger", "en": "I will stay at a hotel.", "pl": "BÄ™dÄ™ mieszkaÄ‡ w hotelu."},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj pytania (EN â†’ PL)",
                "items": [
                    {"en": "What is the purpose of your visit?", "pl": "Jaki jest cel wizyty?"},
                    {"en": "How long are you staying?", "pl": "Jak dÅ‚ugo zostajesz?"},
                    {"en": "Where will you stay?", "pl": "Gdzie bÄ™dziesz mieszkaÄ‡?"},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "What is the ____ of your visit?", "answer": "purpose", "hint": "purpose = cel"},
                    {"sentence": "How long are you ____?", "answer": "staying", "hint": "stay = zostawaÄ‡"},
                    {"sentence": "Where will you ____?", "answer": "stay", "hint": "stay = nocowaÄ‡/mieszkaÄ‡"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak odpowiesz â€Turystykaâ€ po angielsku?", "a": "Tourism."},
                    {"q": "Jak zapytajÄ… â€Jak dÅ‚ugo zostajesz?â€ po angielsku?", "a": "How long are you staying?"},
                ],
            },
        ],
    },

    {
        "id": 36,
        "title": "Lekcja 3.6: Lotnisko â€“ Informacje o locie (Flight Information)",
        "level": "A1/A2",
        "goal": "Rozumiesz: departure/arrival, gate, boarding, delayed/cancelled oraz pytania o bramkÄ™/boarding.",
        "required_phrases": [
            {"en": "departure", "pl": "odlot"},
            {"en": "arrival", "pl": "przylot"},
            {"en": "gate", "pl": "bramka"},
            {"en": "boarding", "pl": "wejÅ›cie na pokÅ‚ad"},
            {"en": "delayed", "pl": "opÃ³Åºniony"},
            {"en": "cancelled", "pl": "odwoÅ‚any"},
            {"en": "What gate is the flight to London?", "pl": "Z ktÃ³rej bramki jest lot do Londynu?"},
            {"en": "Is boarding starting?", "pl": "Czy zaczyna siÄ™ boarding?"},
        ],
        "dialog": [
            {"spk": "Passenger", "en": "What gate is the flight to London?", "pl": "Z ktÃ³rej bramki jest lot do Londynu?"},
            {"spk": "Staff", "en": "It departs from gate 24.", "pl": "Odlatuje z bramki 24."},
            {"spk": "Passenger", "en": "Is boarding starting?", "pl": "Czy zaczyna siÄ™ boarding?"},
            {"spk": "Staff", "en": "Not yet. The flight is delayed.", "pl": "Jeszcze nie. Lot jest opÃ³Åºniony."},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj sÅ‚owa (EN â†’ PL)",
                "items": [
                    {"en": "departure", "pl": "odlot"},
                    {"en": "arrival", "pl": "przylot"},
                    {"en": "gate", "pl": "bramka"},
                    {"en": "boarding", "pl": "wejÅ›cie na pokÅ‚ad"},
                    {"en": "delayed", "pl": "opÃ³Åºniony"},
                    {"en": "cancelled", "pl": "odwoÅ‚any"},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "What ____ is the flight to London?", "answer": "gate", "hint": "gate = bramka"},
                    {"sentence": "Is ____ starting?", "answer": "boarding", "hint": "boarding = wejÅ›cie na pokÅ‚ad"},
                    {"sentence": "The flight is ____.", "answer": "delayed", "hint": "delayed = opÃ³Åºniony"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak zapytasz â€Czy zaczyna siÄ™ boarding?â€ po angielsku?", "a": "Is boarding starting?"},
                    {"q": "Jak powiesz â€Lot jest odwoÅ‚anyâ€ po angielsku?", "a": "The flight is cancelled."},
                ],
            },
        ],
    },

    {
        "id": 37,
        "title": "Lekcja 3.7: Na pokÅ‚adzie samolotu (On board)",
        "level": "A1/A2",
        "goal": "Umiesz znaleÅºÄ‡ miejsce, zapytaÄ‡ o torbÄ™, wodÄ™, miejsce zajÄ™te i rozumiesz polecenie o pasach.",
        "required_phrases": [
            {"en": "Where is my seat?", "pl": "Gdzie jest moje miejsce?"},
            {"en": "Can I put my bag here?", "pl": "Czy mogÄ™ tu poÅ‚oÅ¼yÄ‡ torbÄ™?"},
            {"en": "Could I have some water, please?", "pl": "Czy mogÄ™ prosiÄ‡ o wodÄ™?"},
            {"en": "Is this seat taken?", "pl": "Czy to miejsce jest zajÄ™te?"},
            {"en": "Fasten your seatbelt.", "pl": "Zapnij pasy."},
        ],
        "dialog": [
            {"spk": "Passenger", "en": "Excuse me, where is my seat?", "pl": "Przepraszam, gdzie jest moje miejsce?"},
            {"spk": "Crew", "en": "Your seat is 14A.", "pl": "Twoje miejsce to 14A."},
            {"spk": "Passenger", "en": "Is this seat taken?", "pl": "Czy to miejsce jest zajÄ™te?"},
            {"spk": "Crew", "en": "Please fasten your seatbelt.", "pl": "ProszÄ™ zapiÄ…Ä‡ pasy."},
            {"spk": "Passenger", "en": "Could I have some water, please?", "pl": "Czy mogÄ™ prosiÄ‡ o wodÄ™?"},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zdania (EN â†’ PL)",
                "items": [
                    {"en": "Where is my seat?", "pl": "Gdzie jest moje miejsce?"},
                    {"en": "Is this seat taken?", "pl": "Czy to miejsce jest zajÄ™te?"},
                    {"en": "Fasten your seatbelt.", "pl": "Zapnij pasy."},
                    {"en": "Could I have some water, please?", "pl": "Czy mogÄ™ prosiÄ‡ o wodÄ™?"},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "Where is my ____?", "answer": "seat", "hint": "seat = miejsce"},
                    {"sentence": "Fasten your ____.", "answer": "seatbelt", "hint": "seatbelt = pas"},
                    {"sentence": "Could I have some ____ , please?", "answer": "water", "hint": "water = woda"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak powiesz â€Czy to miejsce jest zajÄ™te?â€ po angielsku?", "a": "Is this seat taken?"},
                    {"q": "Jak powiesz â€Zapnij pasyâ€ po angielsku?", "a": "Fasten your seatbelt."},
                ],
            },
        ],
    },

    {
        "id": 38,
        "title": "Lekcja 3.8: Po przylocie â€“ BagaÅ¼, cÅ‚o i ogÃ³lne zwroty",
        "level": "A1/A2",
        "goal": "Umiesz zapytaÄ‡ o odbiÃ³r bagaÅ¼u, zgÅ‚osiÄ‡ brak bagaÅ¼u, przejÅ›Ä‡ cÅ‚o i uÅ¼ywaÄ‡ uniwersalnych zwrotÃ³w.",
        "required_phrases": [
            {"en": "Where is baggage claim?", "pl": "Gdzie jest odbiÃ³r bagaÅ¼u?"},
            {"en": "My luggage didnâ€™t arrive.", "pl": "MÃ³j bagaÅ¼ nie dotarÅ‚."},
            {"en": "Nothing to declare.", "pl": "Nic do oclenia."},
            {"en": "Something to declare.", "pl": "Mam coÅ› do oclenia."},
            {"en": "Excuse me.", "pl": "Przepraszam."},
            {"en": "Thank you.", "pl": "DziÄ™kujÄ™."},
            {"en": "Thanks a lot.", "pl": "DziÄ™kujÄ™ bardzo."},
            {"en": "Could you help me?", "pl": "Czy moÅ¼esz mi pomÃ³c?"},
            {"en": "I donâ€™t understand.", "pl": "Nie rozumiem."},
            {"en": "Could you repeat, please?", "pl": "Czy moÅ¼esz powtÃ³rzyÄ‡?"},
        ],
        "dialog": [
            {"spk": "Passenger", "en": "Excuse me, where is baggage claim?", "pl": "Przepraszam, gdzie jest odbiÃ³r bagaÅ¼u?"},
            {"spk": "Staff", "en": "Baggage claim is straight ahead.", "pl": "OdbiÃ³r bagaÅ¼u jest prosto."},
            {"spk": "Passenger", "en": "My luggage didnâ€™t arrive. Could you help me?", "pl": "MÃ³j bagaÅ¼ nie dotarÅ‚. Czy moÅ¼esz mi pomÃ³c?"},
            {"spk": "Customs", "en": "Do you have anything to declare?", "pl": "Czy ma Pan/Pani coÅ› do oclenia?"},
            {"spk": "Passenger", "en": "Nothing to declare.", "pl": "Nic do oclenia."},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zwroty (EN â†’ PL)",
                "items": [
                    {"en": "Where is baggage claim?", "pl": "Gdzie jest odbiÃ³r bagaÅ¼u?"},
                    {"en": "My luggage didnâ€™t arrive.", "pl": "MÃ³j bagaÅ¼ nie dotarÅ‚."},
                    {"en": "Nothing to declare.", "pl": "Nic do oclenia."},
                    {"en": "Could you help me?", "pl": "Czy moÅ¼esz mi pomÃ³c?"},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "Where is baggage ____?", "answer": "claim", "hint": "baggage claim = odbiÃ³r bagaÅ¼u"},
                    {"sentence": "My luggage didnâ€™t ____.", "answer": "arrive", "hint": "arrive = dotrzeÄ‡"},
                    {"sentence": "I donâ€™t ____.", "answer": "understand", "hint": "understand = rozumieÄ‡"},
                    {"sentence": "Could you ____ , please?", "answer": "repeat", "hint": "repeat = powtÃ³rzyÄ‡"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak powiesz â€MÃ³j bagaÅ¼ nie dotarÅ‚â€ po angielsku?", "a": "My luggage didnâ€™t arrive."},
                    {"q": "Jak powiesz â€Nic do ocleniaâ€ po angielsku?", "a": "Nothing to declare."},
                ],
            },
        ],
    },

    # -------------------- 4 (kawiarnia) --------------------
    {
        "id": 40,
        "title": "Lekcja 4: Kawiarnia â€“ Zamawianie kawy",
        "level": "A1",
        "goal": "Potrafisz zamÃ³wiÄ‡ kawÄ™ w kawiarni: wybraÄ‡ rodzaj, dodatki, rozmiar i zapÅ‚aciÄ‡.",
        "required_phrases": [
            {"en": "What coffee would you like?", "pl": "JakÄ… kawÄ™ chciaÅ‚byÅ›/chciaÅ‚abyÅ›?"},
            {"en": "I would like a coffee, please.", "pl": "PoproszÄ™ kawÄ™."},
            {"en": "cappuccino", "pl": "cappuccino"},
            {"en": "espresso", "pl": "espresso"},
            {"en": "iced coffee", "pl": "kawa mroÅ¼ona"},
            {"en": "Could I have some milk in my coffee, please?", "pl": "PoproszÄ™ mleko do kawy."},
            {"en": "Would you like any sugar?", "pl": "Czy chciaÅ‚byÅ›/chciaÅ‚abyÅ› cukier?"},
            {"en": "Without sugar.", "pl": "Bez cukru."},
            {"en": "What size would you like?", "pl": "Jaki rozmiar?"},
            {"en": "Medium, please.", "pl": "Åšredni, proszÄ™."},
            {"en": "Iâ€™ll pay by card.", "pl": "ZapÅ‚acÄ™ kartÄ…."},
        ],
        "dialog": [
            {"spk": "Barista", "en": "Good morning! What coffee would you like?", "pl": "DzieÅ„ dobry! JakÄ… kawÄ™ chciaÅ‚byÅ›/chciaÅ‚abyÅ›?"},
            {"spk": "Customer", "en": "Yes, I would like a coffee, please.", "pl": "Tak, poproszÄ™ kawÄ™."},
            {"spk": "Barista", "en": "Would you like to try a cappuccino, espresso, or iced coffee?", "pl": "Czy chciaÅ‚byÅ›/chciaÅ‚abyÅ› sprÃ³bowaÄ‡ cappuccino, espresso czy kawy mroÅ¼onej?"},
            {"spk": "Customer", "en": "An iced coffee, please.", "pl": "PoproszÄ™ kawÄ™ mroÅ¼onÄ…."},
            {"spk": "Customer", "en": "Could I have some milk in my coffee, please?", "pl": "PoproszÄ™ mleko do kawy."},
            {"spk": "Barista", "en": "Sure! Would you like any sugar?", "pl": "OczywiÅ›cie! Czy chciaÅ‚byÅ›/chciaÅ‚abyÅ› cukier?"},
            {"spk": "Customer", "en": "No, please. Without sugar.", "pl": "Nie, proszÄ™. Bez cukru."},
            {"spk": "Barista", "en": "What size would you like?", "pl": "Jaki rozmiar?"},
            {"spk": "Customer", "en": "Medium, please.", "pl": "Åšredni, proszÄ™."},
            {"spk": "Barista", "en": "Perfect! May I have your name for the order?", "pl": "Åšwietnie! Czy mogÄ™ prosiÄ‡ o imiÄ™ do zamÃ³wienia?"},
            {"spk": "Customer", "en": "My name is Dominik.", "pl": "Mam na imiÄ™ Dominik."},
            {"spk": "Barista", "en": "Thanks, Dominik! That will be five dollars.", "pl": "DziÄ™kujÄ™, Dominik! To bÄ™dzie piÄ™Ä‡ dolarÃ³w."},
            {"spk": "Customer", "en": "Iâ€™ll pay by card.", "pl": "ZapÅ‚acÄ™ kartÄ…."},
            {"spk": "Barista", "en": "Here you go. Enjoy your coffee!", "pl": "ProszÄ™ bardzo. Smacznej kawy!"},
            {"spk": "Customer", "en": "Thank you! Have a nice day!", "pl": "DziÄ™kujÄ™! MiÅ‚ego dnia!"},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zwroty (EN â†’ PL)",
                "items": [
                    {"en": "What coffee would you like?", "pl": "JakÄ… kawÄ™ chciaÅ‚byÅ›/chciaÅ‚abyÅ›?"},
                    {"en": "An iced coffee, please.", "pl": "PoproszÄ™ kawÄ™ mroÅ¼onÄ…."},
                    {"en": "Without sugar.", "pl": "Bez cukru."},
                    {"en": "Iâ€™ll pay by card.", "pl": "ZapÅ‚acÄ™ kartÄ…."},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "Could I have some ____ in my coffee, please?", "answer": "milk", "hint": "milk = mleko"},
                    {"sentence": "What ____ would you like?", "answer": "size", "hint": "size = rozmiar"},
                    {"sentence": "Iâ€™ll pay by ____.", "answer": "card", "hint": "card = karta"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak powiesz â€PoproszÄ™ mleko do kawyâ€ po angielsku?", "a": "Could I have some milk in my coffee, please?"},
                    {"q": "Jak powiesz â€Bez cukruâ€ po angielsku?", "a": "Without sugar."},
                ],
            },
        ],
    },

    # -------------------- 4.1 (restauracja) --------------------
    {
        "id": 41,
        "title": "Lekcja 4.1: Restauracja â€“ Zamawianie jedzenia",
        "level": "A1/A2",
        "goal": "Potrafisz zamÃ³wiÄ‡ jedzenie: poprosiÄ‡ o menu, zÅ‚oÅ¼yÄ‡ zamÃ³wienie, poprosiÄ‡ o rachunek i zapÅ‚aciÄ‡.",
        "required_phrases": [
            {"en": "A table for one / two, please.", "pl": "Stolik dla jednej osoby / dwÃ³ch osÃ³b, proszÄ™."},
            {"en": "Could we have the menu, please?", "pl": "Czy moÅ¼emy prosiÄ‡ o menu?"},
            {"en": "I would like to order, please.", "pl": "ChciaÅ‚bym/chciaÅ‚abym zÅ‚oÅ¼yÄ‡ zamÃ³wienie."},
            {"en": "Iâ€™ll have the chicken, please.", "pl": "PoproszÄ™ kurczaka."},
            {"en": "Can I have a glass of water, please?", "pl": "Czy mogÄ™ prosiÄ‡ o szklankÄ™ wody?"},
            {"en": "No onions, please.", "pl": "Bez cebuli, proszÄ™."},
            {"en": "Could I get the bill, please?", "pl": "Czy mogÄ™ prosiÄ‡ o rachunek?"},
            {"en": "Can I pay by card?", "pl": "Czy mogÄ™ zapÅ‚aciÄ‡ kartÄ…?"},
            {"en": "Thank you. It was delicious.", "pl": "DziÄ™kujÄ™. ByÅ‚o pyszne."},
        ],
        "dialog": [
            {"spk": "Waiter", "en": "Good evening! A table for one or two?", "pl": "Dobry wieczÃ³r! Stolik dla jednej osoby czy dla dwÃ³ch?"},
            {"spk": "Customer", "en": "A table for one, please.", "pl": "Stolik dla jednej osoby, proszÄ™."},
            {"spk": "Customer", "en": "Could we have the menu, please?", "pl": "Czy moÅ¼emy prosiÄ‡ o menu?"},
            {"spk": "Waiter", "en": "Of course. Here you are.", "pl": "OczywiÅ›cie. ProszÄ™ bardzo."},
            {"spk": "Customer", "en": "I would like to order, please. Iâ€™ll have the chicken, please.", "pl": "ChciaÅ‚bym/chciaÅ‚abym zÅ‚oÅ¼yÄ‡ zamÃ³wienie. PoproszÄ™ kurczaka."},
            {"spk": "Customer", "en": "No onions, please.", "pl": "Bez cebuli, proszÄ™."},
            {"spk": "Customer", "en": "Could I get the bill, please?", "pl": "Czy mogÄ™ prosiÄ‡ o rachunek?"},
            {"spk": "Waiter", "en": "Sure.", "pl": "OczywiÅ›cie."},
            {"spk": "Customer", "en": "Can I pay by card?", "pl": "Czy mogÄ™ zapÅ‚aciÄ‡ kartÄ…?"},
            {"spk": "Customer", "en": "Thank you. It was delicious.", "pl": "DziÄ™kujÄ™. ByÅ‚o pyszne."},
        ],
        "exercises": [
            {
                "type": "match",
                "title": "Dopasuj zwroty (EN â†’ PL)",
                "items": [
                    {"en": "Could we have the menu, please?", "pl": "Czy moÅ¼emy prosiÄ‡ o menu?"},
                    {"en": "I would like to order, please.", "pl": "ChciaÅ‚bym/chciaÅ‚abym zÅ‚oÅ¼yÄ‡ zamÃ³wienie."},
                    {"en": "Could I get the bill, please?", "pl": "Czy mogÄ™ prosiÄ‡ o rachunek?"},
                    {"en": "Can I pay by card?", "pl": "Czy mogÄ™ zapÅ‚aciÄ‡ kartÄ…?"},
                ],
            },
            {
                "type": "fill",
                "title": "UzupeÅ‚nij luki",
                "items": [
                    {"sentence": "Could we have the ____, please?", "answer": "menu", "hint": "menu = menu"},
                    {"sentence": "I would like to ____, please.", "answer": "order", "hint": "order = zamÃ³wiÄ‡"},
                    {"sentence": "Could I get the ____, please?", "answer": "bill", "hint": "bill = rachunek"},
                    {"sentence": "Can I pay by ____?", "answer": "card", "hint": "card = karta"},
                ],
            },
            {
                "type": "quiz",
                "title": "Mini quiz",
                "items": [
                    {"q": "Jak poprosisz o menu po angielsku?", "a": "Could we have the menu, please?"},
                    {"q": "Jak powiesz â€Bez cebuli, proszÄ™â€ po angielsku?", "a": "No onions, please."},
                    {"q": "Jak poprosisz o rachunek po angielsku?", "a": "Could I get the bill, please?"},
                ],
            },
        ],
    },


    # --- resztÄ™ Twoich lekcji (32â€“41) zostawiam jak u Ciebie w kodzie ---
    # Dla oszczÄ™dnoÅ›ci miejsca w odpowiedzi: jeÅ›li chcesz, dopisz je tu identycznie
    # (albo wklej swoje lekcje, a ja wstawiÄ™ peÅ‚nÄ… listÄ™ 1:1).
]

# Uwaga:
# W tej wersji w odpowiedzi nie wkleiÅ‚em Twoich lekcji 32â€“41 wyÅ‚Ä…cznie dlatego,
# Å¼e wiadomoÅ›Ä‡ staÅ‚aby siÄ™ gigantyczna (limit czatu).
# Mechanika dziaÅ‚a dla kaÅ¼dej liczby lekcji w LESSONS.


def load_lesson_progress() -> dict:
    if not os.path.exists(LESSONS_FILE):
        return {"completed": {}, "scores": {}}
    with open(LESSONS_FILE, "r", encoding="utf-8") as f:
        return json.load(f)


def save_lesson_progress(p: dict) -> None:
    with open(LESSONS_FILE, "w", encoding="utf-8") as f:
        json.dump(p, f, ensure_ascii=False, indent=2)


def lesson_missing_phrases(words_dict: dict, lesson: dict) -> list:
    words = list(words_dict.values())
    missing = []
    for rp in lesson["required_phrases"]:
        found = any(norm(w.en) == norm(rp["en"]) and norm(w.pl) == norm(rp["pl"]) for w in words)
        if not found:
            missing.append(rp)
    return missing


def lesson_phrases_pool(include_dialog: bool = False) -> List[dict]:
    """
    Pool do quizu "ze wszystkich lekcji".
    Zwraca listÄ™ rekordÃ³w: {"en":..., "pl":..., "tag":..., "lesson_id":...}
    """
    out = []
    for lesson in LESSONS:
        lid = str(lesson.get("id"))
        tag = f"lesson{lid}"
        for rp in lesson.get("required_phrases", []):
            out.append({"en": rp["en"], "pl": rp["pl"], "tag": tag, "lesson_id": lid})
        if include_dialog:
            for line in lesson.get("dialog", []):
                # dialog moÅ¼e mieÄ‡ dÅ‚ugie zdania â€“ opcjonalnie
                en = (line.get("en") or "").strip()
                pl = (line.get("pl") or "").strip()
                if en and pl:
                    out.append({"en": en, "pl": pl, "tag": tag, "lesson_id": lid})
    # usuwanie duplikatÃ³w
    uniq = {}
    for it in out:
        k = (norm(it["en"]), norm(it["pl"]))
        if k not in uniq:
            uniq[k] = it
    return list(uniq.values())


# ============================
# UI (wbudowany HTML/CSS)
# ============================

BASE_HTML = """
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{title}}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b1220; color:#e7eefc; margin:0}
    a{color:#a7c5ff; text-decoration:none}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:14px 18px; background:rgba(255,255,255,0.04); position:sticky; top:0; backdrop-filter: blur(8px)}
    .brand{font-weight:800}
    .nav a{margin-right:10px; padding:8px 10px; border-radius:12px; background:rgba(255,255,255,0.05)}
    .wrap{max-width:1100px; margin:0 auto; padding:18px}
    .grid{display:grid; grid-template-columns: 1.15fr 0.85fr; gap:16px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.09); border-radius:18px; padding:14px}
    .btn{display:inline-block; padding:10px 14px; border-radius:14px;
      background: linear-gradient(135deg,#7c3aed,#2563eb);
      color:white; border:none; cursor:pointer; font-weight:700;
      box-shadow: 0 12px 30px rgba(37,99,235,0.25);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.06)}
    .btn:active{transform: translateY(0px); filter: brightness(0.98)}
    .btn-ghost{background: rgba(255,255,255,0.08); box-shadow:none}
    .danger{background: linear-gradient(135deg,#ef4444,#b91c1c);}
    input, textarea, select{
      width:100%; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25); color:#e7eefc;
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .muted{opacity:.85}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:rgba(255,255,255,0.08); margin-right:6px; font-size:12px}
    .list{display:flex; flex-direction:column; gap:10px}
    .hr{height:1px; background:rgba(255,255,255,0.08); margin:12px 0}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .big{font-size:26px; font-weight:900}
    .flash{padding:10px 12px; border-radius:14px; margin:0 0 12px 0; background:rgba(34,197,94,0.15); border:1px solid rgba(34,197,94,0.25)}
    .flash.err{background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.25)}
    code{background: rgba(255,255,255,0.08); padding:2px 6px; border-radius:8px}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,0.08); padding:10px; text-align:left}
    th{opacity:.9}

    /* ===== TTS ===== */
    .tts-btn{
      border:none; cursor:pointer; margin-left:8px;
      border-radius:12px; padding:8px 10px;
      background: rgba(255,255,255,0.08);
      color:#e7eefc;
      transition: transform .12s ease, filter .12s ease;
    }
    .tts-btn:hover{transform: translateY(-1px); filter: brightness(1.07)}
    .tts-btn:active{transform: translateY(0px); filter: brightness(0.98)}
    .tts-sm{padding:6px 8px; border-radius:10px; font-size:12px}

    .tts-panel{
      position:fixed; right:16px; bottom:16px; width:320px; max-width:calc(100vw - 32px);
      background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
      border-radius:18px; padding:12px; backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
      display:none; z-index:60;
    }
    .tts-panel.show{display:block}
    .mini-btn{background: rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.14); color:#e7eefc; border-radius:12px; padding:8px 10px; cursor:pointer}
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">{{title}}</div>
    <div class="nav">
      <a href="{{ url_for('home') }}">Start</a>
      <a href="{{ url_for('materials_list') }}">MateriaÅ‚y</a>
      <a href="{{ url_for('lessons_list') }}">Lekcje</a>
      <a href="{{ url_for('words_page') }}">SÅ‚ownik</a>
      <a href="{{ url_for('quiz_page') }}">Quiz</a>
      <a href="{{ url_for('review_page') }}">PowtÃ³rki</a>
      <a href="{{ url_for('stats_page') }}">Statystyki</a>
      <a href="{{ url_for('settings_page') }}">Import/Eksport</a>
      <a href="#" id="ttsOpen">ğŸ”Š Audio</a>
    </div>
  </div>
  <div class="wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat,msg in messages %}
          <div class="flash {% if cat=='err' %}err{% endif %}">{{msg}}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {{ body|safe }}
  </div>

  <!-- TTS panel -->
  <div class="tts-panel" id="ttsPanel" aria-hidden="true">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <b>ğŸ”Š Wymowa (TTS)</b>
      <button type="button" class="mini-btn" id="ttsClose">Zamknij</button>
    </div>
    <div class="hr"></div>

    <label style="font-size:12px; opacity:.9">GÅ‚os</label>
    <select id="ttsVoice" style="width:100%; margin:6px 0 10px 0;"></select>

    <div style="display:flex; justify-content:space-between; align-items:center;">
      <label style="font-size:12px; opacity:.9">SzybkoÅ›Ä‡</label>
      <span id="ttsRateLabel" style="font-size:12px; opacity:.9">1.0Ã—</span>
    </div>
    <input id="ttsRate" type="range" min="0.6" max="1.4" step="0.05" value="1.0" style="width:100%">

    <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
      <button type="button" class="mini-btn" id="ttsTest">Test</button>
      <button type="button" class="mini-btn" id="ttsStop">Stop</button>
    </div>

    <div style="font-size:12px; opacity:.8; margin-top:8px;">
      Ustawienia zapisujÄ… siÄ™ w przeglÄ…darce (gÅ‚os + szybkoÅ›Ä‡).
    </div>
  </div>

  <script>
  (function(){
    const panel = document.getElementById('ttsPanel');
    const openBtn = document.getElementById('ttsOpen');
    const closeBtn = document.getElementById('ttsClose');
    const voiceSel = document.getElementById('ttsVoice');
    const rateInp = document.getElementById('ttsRate');
    const rateLbl = document.getElementById('ttsRateLabel');
    const testBtn = document.getElementById('ttsTest');
    const stopBtn = document.getElementById('ttsStop');

    const LS_VOICE = "tts_voice_uri";
    const LS_RATE = "tts_rate";

    function getRate(){
      const v = parseFloat(localStorage.getItem(LS_RATE) || "1.0");
      return isNaN(v) ? 1.0 : v;
    }
    function setRate(v){ localStorage.setItem(LS_RATE, String(v)); }
    function getVoiceUri(){ return localStorage.getItem(LS_VOICE) || ""; }
    function setVoiceUri(uri){ localStorage.setItem(LS_VOICE, uri); }

    function showPanel(){ panel.classList.add('show'); panel.setAttribute('aria-hidden','false'); }
    function hidePanel(){ panel.classList.remove('show'); panel.setAttribute('aria-hidden','true'); }

    openBtn && openBtn.addEventListener('click', (e)=>{ e.preventDefault(); showPanel(); });
    closeBtn && closeBtn.addEventListener('click', hidePanel);

    function stopSpeak(){ if ('speechSynthesis' in window) window.speechSynthesis.cancel(); }
    stopBtn && stopBtn.addEventListener('click', stopSpeak);

    function loadVoices(){
      if(!('speechSynthesis' in window)) return;
      const voices = window.speechSynthesis.getVoices() || [];
      const saved = getVoiceUri();
      voiceSel.innerHTML = "";
      voices.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.voiceURI;
        opt.textContent = `${v.name} (${v.lang})${v.default ? " â€¢ domyÅ›lny" : ""}`;
        if (v.voiceURI === saved) opt.selected = true;
        voiceSel.appendChild(opt);
      });

      if(!saved && voices.length){
        const pref = voices.find(v=> (v.lang||"").toLowerCase().startsWith("en-")) || voices[0];
        if(pref){
          setVoiceUri(pref.voiceURI);
          [...voiceSel.options].forEach(o=> o.selected = (o.value === pref.voiceURI));
        }
      }
    }

    if ('speechSynthesis' in window){
      window.speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
    }

    const initRate = getRate();
    rateInp.value = initRate;
    rateLbl.textContent = initRate.toFixed(2) + "Ã—";
    rateInp.addEventListener('input', ()=>{
      const v = parseFloat(rateInp.value);
      rateLbl.textContent = v.toFixed(2) + "Ã—";
      setRate(v);
    });

    voiceSel.addEventListener('change', ()=> setVoiceUri(voiceSel.value));

    function pickVoice(){
      const uri = getVoiceUri();
      const voices = ('speechSynthesis' in window) ? (window.speechSynthesis.getVoices() || []) : [];
      return voices.find(v=> v.voiceURI === uri) || null;
    }

    function speak(text){
      if(!('speechSynthesis' in window)){
        alert("Brak wsparcia TTS w tej przeglÄ…darce.");
        return;
      }
      stopSpeak();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if(v) u.voice = v;
      u.rate = getRate();
      u.pitch = 1.0;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);
    }

    testBtn && testBtn.addEventListener('click', ()=> speak("Hello! This is a pronunciation test."));
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tts-btn');
      if(!btn) return;
      const txt = btn.getAttribute('data-tts') || "";
      if(!txt) return;
      speak(txt);
    });
  })();
  </script>
</body>
</html>
"""


def render(body_html: str, **ctx):
    return render_template_string(BASE_HTML, title=APP_TITLE, body=body_html, **ctx)


# ============================
# ROUTES
# ============================

@app.route("/")
def home():
    words = load_words()
    total = len(words)
    due = len(due_words(words))
    learned = sum(1 for w in words.values() if w.reps >= 3)

    body = f"""
    <div class="card">
      <div class="big">Twoja nauka angielskiego</div>
      <p class="muted">Dodajesz sÅ‚Ã³wka do sÅ‚ownika, a lekcje dziaÅ‚ajÄ… jak w aplikacjach: teoria + dialog + Ä‡wiczenia + zaliczenie.</p>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div class="card">
        <h2>Dodaj nowe sÅ‚Ã³wko</h2>
        <form method="post" action="{url_for('add_word')}">
          <div class="row">
            <div>
              <label>Angielski</label>
              <input name="en" placeholder="np. Could we have the menu, please?" required>
            </div>
            <div>
              <label>Polski</label>
              <input name="pl" placeholder="np. Czy moÅ¼emy prosiÄ‡ o menu?" required>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Tagi (po przecinku)</label>
              <input name="tags" placeholder="np. lesson1, airport, restaurant">
            </div>
            <div>
              <label>PrzykÅ‚ad zdania</label>
              <input name="example" placeholder="np. I would like to order, please.">
            </div>
          </div>
          <div style="margin-top:10px">
            <label>Notatki</label>
            <textarea name="notes" placeholder="np. wymowa, synonimy..."></textarea>
          </div>
          <div class="actions" style="margin-top:12px">
            <button class="btn" type="submit">Dodaj sÅ‚Ã³wko</button>
            <a class="btn btn-ghost" href="{url_for('lessons_list')}">Lekcje</a>
            <a class="btn btn-ghost" href="{url_for('materials_list')}">MateriaÅ‚y</a>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Podsumowanie</h2>
        <p class="muted">SÅ‚Ã³wka w bazie: <b>{total}</b></p>
        <p class="muted">Do powtÃ³rki dziÅ›: <b>{due}</b></p>
        <p class="muted">Utrwalone (reps â‰¥ 3): <b>{learned}</b></p>
        <div class="hr"></div>
        <div class="actions">
          <a class="btn" href="{url_for('lessons_list')}">Lekcje</a>
          <a class="btn btn-ghost" href="{url_for('materials_list')}">MateriaÅ‚y</a>
          <a class="btn btn-ghost" href="{url_for('review_page')}">PowtÃ³rki</a>
        </div>
      </div>
    </div>
    """
    return render(body)


# ----------------------------
# MATERIAÅY
# ----------------------------

@app.route("/materials")
def materials_list():
    cards = ""
    for m in MATERIALS:
        cards += f"""
        <div class="card">
          <h3 style="margin:0 0 6px 0">{m["title"]}</h3>
          <div class="actions" style="margin-top:10px">
            <a class="btn" href="{url_for('material_view', material_id=m['id'])}">OtwÃ³rz</a>
          </div>
        </div>
        """

    body = f"""
    <div class="card">
      <h2>MateriaÅ‚y</h2>
      <p class="muted">Teoria/gramatyka w piguÅ‚ce. MoÅ¼esz do tego wracaÄ‡ w dowolnym momencie.</p>
    </div>
    <div class="hr"></div>
    <div class="list">{cards}</div>
    """
    return render(body)


@app.route("/materials/<material_id>")
def material_view(material_id: str):
    m = next((x for x in MATERIALS if x["id"] == material_id), None)
    if not m:
        flash("Nie znaleziono materiaÅ‚u.", "err")
        return redirect(url_for("materials_list"))

    sections_html = ""
    for sec in m.get("sections", []):
        rows = ""
        for it in sec.get("items", []):
            rows += f"<tr><td><b>{it['en']}</b> {tts_btn(it['en'])}</td><td>{it['pl']}</td></tr>"
        sections_html += f"""
        <div class="card">
          <h3 style="margin:0 0 10px 0">{sec["title"]}</h3>
          <table>
            <thead><tr><th>EN</th><th>PL</th></tr></thead>
            <tbody>{rows}</tbody>
          </table>
        </div>
        """

    ex_rows = ""
    for e in m.get("examples", []):
        ex_rows += f"<tr><td><b>{e['en']}</b> {tts_btn(e['en'])}</td><td>{e['pl']}</td></tr>"
    examples_html = f"""
    <div class="card">
      <h3 style="margin:0 0 10px 0">PrzykÅ‚ady</h3>
      <table>
        <thead><tr><th>EN</th><th>PL</th></tr></thead>
        <tbody>{ex_rows}</tbody>
      </table>
    </div>
    """ if m.get("examples") else ""

    body = f"""
    <div class="card">
      <h2>{m["title"]}</h2>
      <div class="actions" style="margin-top:10px">
        <a class="btn btn-ghost" href="{url_for('materials_list')}">WrÃ³Ä‡</a>
        <a class="btn btn-ghost" href="{url_for('lessons_list')}">Lekcje</a>
      </div>
    </div>
    <div class="hr"></div>
    <div class="list">
      {sections_html}
      {examples_html}
    </div>
    """
    return render(body)


# ----------------------------
# SÅOWNIK
# ----------------------------

@app.route("/add", methods=["POST"])
def add_word():
    words = load_words()

    en = (request.form.get("en", "") or "").strip()
    pl = (request.form.get("pl", "") or "").strip()
    if not en or not pl:
        flash("UzupeÅ‚nij angielski i polski.", "err")
        return redirect(url_for("home"))

    tags_raw = (request.form.get("tags", "") or "").strip()
    tags = [t.strip() for t in tags_raw.split(",") if t.strip()] if tags_raw else []

    wid = f"w{(len(words) + 1):04d}"
    w = Word(
        id=wid,
        en=en,
        pl=pl,
        example=(request.form.get("example", "") or "").strip(),
        notes=(request.form.get("notes", "") or "").strip(),
        tags=tags,
        created_at=now_iso(),
        next_review=now_iso(),
        interval_days=0,
        ease=2.5,
        reps=0,
    )
    words[w.id] = w
    save_words(words)

    flash("Dodano sÅ‚Ã³wko âœ…", "ok")
    return redirect(url_for("words_page"))


@app.route("/words")
def words_page():
    words = load_words()
    q = (request.args.get("q", "") or "").strip().lower()
    tag = (request.args.get("tag", "") or "").strip()

    items = list(words.values())
    if q:
        items = [w for w in items if q in w.en.lower() or q in w.pl.lower() or q in (w.example or "").lower()]
    if tag:
        items = [w for w in items if tag in (w.tags or [])]

    items.sort(key=lambda w: w.created_at, reverse=True)
    all_tags = sorted({t for w in words.values() for t in (w.tags or [])})

    def card(w: Word) -> str:
        tags_html = "".join([f'<span class="pill">{t}</span>' for t in (w.tags or [])])
        due = "âœ…" if parse_iso(w.next_review) <= datetime.now() else "â³"
        return f"""
        <div class="card">
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start">
            <div>
              <h3 style="margin:0 0 6px 0">{w.en} {tts_btn(w.en)} <span class="muted">â†’</span> {w.pl}</h3>
              <div>{tags_html}</div>
              <div class="muted" style="margin-top:6px">{("PrzykÅ‚ad: " + w.example) if w.example else ""}</div>
              <div class="muted" style="margin-top:6px">PowtÃ³rka: {w.next_review or "-"} {due} â€¢ poprawne: {w.correct} â€¢ bÅ‚Ä™dne: {w.wrong}</div>
              {f'<div class="muted" style="margin-top:8px">{w.notes}</div>' if w.notes else ''}
            </div>
            <div class="actions">
              <a class="btn btn-ghost" href="{url_for('edit_word', wid=w.id)}">Edytuj</a>
              <form method="post" action="{url_for('delete_word', wid=w.id)}" onsubmit="return confirm('UsunÄ…Ä‡ to sÅ‚Ã³wko?');">
                <button class="btn danger" type="submit">UsuÅ„</button>
              </form>
            </div>
          </div>
        </div>
        """

    cards = "".join([card(w) for w in items]) if items else '<div class="card muted">Brak wynikÃ³w.</div>'
    tags_links = " ".join([f'<a class="pill" href="{url_for("words_page", tag=t)}">{t}</a>' for t in all_tags]) or "<span class='muted'>Brak tagÃ³w.</span>"

    body = f"""
    <div class="grid">
      <div class="card">
        <h2>SÅ‚ownik</h2>
        <form method="get" action="{url_for('words_page')}">
          <div class="row">
            <div><input name="q" value="{q}" placeholder="Szukaj (en/pl/przykÅ‚ad)"></div>
            <div>
              <select name="tag">
                <option value="">(filtr tag)</option>
                {''.join([f'<option value="{t}" {"selected" if t==tag else ""}>{t}</option>' for t in all_tags])}
              </select>
            </div>
          </div>
          <div class="actions" style="margin-top:10px">
            <button class="btn" type="submit">Szukaj</button>
            <a class="btn btn-ghost" href="{url_for('words_page')}">Reset</a>
          </div>
        </form>
        <div class="hr"></div>
        <div class="muted">Tagi: {tags_links}</div>
      </div>

      <div class="card">
        <h2>Szybkie akcje</h2>
        <div class="actions">
          <a class="btn" href="{url_for('lessons_list')}">Lekcje</a>
          <a class="btn btn-ghost" href="{url_for('materials_list')}">MateriaÅ‚y</a>
          <a class="btn btn-ghost" href="{url_for('quiz_page')}">Quiz</a>
          <a class="btn btn-ghost" href="{url_for('review_page')}">PowtÃ³rki</a>
        </div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="list">{cards}</div>
    """
    return render(body)


@app.route("/words/<wid>/edit", methods=["GET", "POST"])
def edit_word(wid: str):
    words = load_words()
    if wid not in words:
        flash("Nie znaleziono sÅ‚Ã³wka.", "err")
        return redirect(url_for("words_page"))

    w = words[wid]
    if request.method == "POST":
        w.en = (request.form.get("en", "") or "").strip()
        w.pl = (request.form.get("pl", "") or "").strip()
        w.example = (request.form.get("example", "") or "").strip()
        w.notes = (request.form.get("notes", "") or "").strip()
        tags_raw = (request.form.get("tags", "") or "").strip()
        w.tags = [t.strip() for t in tags_raw.split(",") if t.strip()] if tags_raw else []

        save_words(words)
        flash("Zapisano zmiany âœ…", "ok")
        return redirect(url_for("words_page"))

    body = f"""
    <div class="card">
      <h2>Edytuj sÅ‚Ã³wko: {w.id}</h2>
      <form method="post">
        <div class="row">
          <div>
            <label>Angielski</label>
            <input name="en" value="{w.en}" required>
          </div>
          <div>
            <label>Polski</label>
            <input name="pl" value="{w.pl}" required>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Tagi (po przecinku)</label>
            <input name="tags" value="{', '.join(w.tags or [])}">
          </div>
          <div>
            <label>PrzykÅ‚ad</label>
            <input name="example" value="{w.example}">
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Notatki</label>
          <textarea name="notes">{w.notes}</textarea>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn" type="submit">Zapisz</button>
          <a class="btn btn-ghost" href="{url_for('words_page')}">PowrÃ³t</a>
        </div>
      </form>
    </div>
    """
    return render(body)


@app.route("/words/<wid>/delete", methods=["POST"])
def delete_word(wid: str):
    words = load_words()
    if wid in words:
        del words[wid]
        save_words(words)
        flash("UsuniÄ™to sÅ‚Ã³wko.", "ok")
    return redirect(url_for("words_page"))


# ----------------------------
# LEKCJE
# ----------------------------

@app.route("/lessons")
def lessons_list():
    words = load_words()
    prog = load_lesson_progress()

    cards = ""
    for lesson in LESSONS:
        missing = lesson_missing_phrases(words, lesson)
        done = str(lesson["id"]) in prog.get("completed", {})
        score = prog.get("scores", {}).get(str(lesson["id"]), None)

        status = "âœ… Zaliczone" if done else ("âš ï¸ Brakuje zwrotÃ³w" if missing else "â–¶ï¸ Gotowa do startu")
        extra = f"<div class='muted'>Ostatni wynik: <b>{score}%</b></div>" if score is not None else ""
        need = f"<div class='muted'>Braki: <b>{len(missing)}</b> (dodaj do sÅ‚ownika)</div>" if missing else ""

        cards += f"""
        <div class="card">
          <h3 style="margin:0 0 6px 0">{lesson['title']} <span class="pill">{lesson['level']}</span></h3>
          <div class="muted">{lesson['goal']}</div>
          <div class="hr"></div>
          <div><b>Status:</b> {status}</div>
          {extra}
          {need}
          <div class="actions" style="margin-top:10px">
            <a class="btn" href="{url_for('lesson_view', lesson_id=lesson['id'])}">OtwÃ³rz lekcjÄ™</a>
            <a class="btn btn-ghost" href="{url_for('words_page')}">SÅ‚ownik</a>
          </div>
        </div>
        """

    body = f"""
    <div class="card">
      <h2>Lekcje</h2>
      <p class="muted">
        Lekcje = mini sÅ‚ownik + dialog + Ä‡wiczenia + zaliczenie.
        <br><b>Ty</b> dodajesz zwroty do sÅ‚ownika, a lekcja wykrywa braki.
      </p>
      <div class="hr"></div>
      <p class="muted"><b>NowoÅ›Ä‡:</b> ğŸ”Š audio jest przy EN w lekcjach, quizie i materiaÅ‚ach.</p>
    </div>
    <div class="hr"></div>
    <div class="list">{cards}</div>
    """
    return render(body)


@app.route("/lesson/<int:lesson_id>", methods=["GET", "POST"])
def lesson_view(lesson_id: int):
    lesson = next((l for l in LESSONS if l["id"] == lesson_id), None)
    if not lesson:
        flash("Nie ma takiej lekcji.", "err")
        return redirect(url_for("lessons_list"))

    words = load_words()
    prog = load_lesson_progress()
    missing = lesson_missing_phrases(words, lesson)

    if missing:
        missing_html = "".join([f"<li><b>{m['en']}</b> {tts_btn(m['en'])} â€” {m['pl']}</li>" for m in missing])
        body = f"""
        <div class="card">
          <h2>{lesson['title']}</h2>
          <p class="muted">{lesson['goal']}</p>
          <div class="hr"></div>
          <h3>Najpierw dodaj do sÅ‚ownika te zwroty:</h3>
          <ul>{missing_html}</ul>
          <div class="actions">
            <a class="btn" href="{url_for('words_page')}">PrzejdÅº do sÅ‚ownika</a>
            <a class="btn btn-ghost" href="{url_for('lessons_list')}">WrÃ³Ä‡ do lekcji</a>
          </div>
        </div>
        """
        return render(body)

    if request.method == "POST":
        total = 0
        good = 0

        match_items = lesson["exercises"][0]["items"]
        for idx, item in enumerate(match_items):
            total += 1
            user = norm(request.form.get(f"m_{idx}", ""))
            if user == norm(item["pl"]):
                good += 1

        fill_items = lesson["exercises"][1]["items"]
        for idx, item in enumerate(fill_items):
            total += 1
            user = norm(request.form.get(f"f_{idx}", ""))
            if user == norm(item["answer"]):
                good += 1

        quiz_items = lesson["exercises"][2]["items"]
        for idx, item in enumerate(quiz_items):
            total += 1
            user = norm(request.form.get(f"q_{idx}", ""))
            if user == norm(item["a"]):
                good += 1

        score = int(round((good / max(total, 1)) * 100))
        prog.setdefault("scores", {})[str(lesson_id)] = score

        if score >= 70:
            prog.setdefault("completed", {})[str(lesson_id)] = True
            flash(f"Zaliczone âœ… Wynik: {score}% (prÃ³g 70%)", "ok")
        else:
            flash(f"Jeszcze nie âœ… Wynik: {score}% (sprÃ³buj ponownie, prÃ³g 70%)", "err")

        save_lesson_progress(prog)
        return redirect(url_for("lesson_view", lesson_id=lesson_id))

    score = prog.get("scores", {}).get(str(lesson_id))
    done = str(lesson_id) in prog.get("completed", {})

    phrases_html = "".join([
        f"<div class='card'><b>{rp['en']}</b> {tts_btn(rp['en'])} â†’ {rp['pl']}</div>"
        for rp in lesson["required_phrases"]
    ])

    dialog_html = ""
    for line in lesson["dialog"]:
        dialog_html += f"""
        <div class="card">
          <b>{line['spk']}:</b> {line['en']} {tts_btn(line['en'])}<br>
          <span class="muted">{line['pl']}</span>
        </div>
        """

    match_items = lesson["exercises"][0]["items"]
    match_html = ""
    for idx, it in enumerate(match_items):
        match_html += f"""
        <div class="card">
          <b>{it['en']}</b> {tts_btn(it['en'])}
          <div style="margin-top:8px">
            <input name="m_{idx}" placeholder="Wpisz po polsku (dokÅ‚adnie sens)">
          </div>
          <div class="muted" style="margin-top:6px">WskazÃ³wka: {it['pl']}</div>
        </div>
        """

    fill_items = lesson["exercises"][1]["items"]
    fill_html = ""
    for idx, it in enumerate(fill_items):
        fill_html += f"""
        <div class="card">
          <div class="big" style="font-size:20px">{it['sentence']}</div>
          <div style="margin-top:8px">
            <input name="f_{idx}" placeholder="Wpisz brakujÄ…ce sÅ‚owo">
          </div>
          <div class="muted" style="margin-top:6px">PodpowiedÅº: {it['hint']}</div>
        </div>
        """

    quiz_items = lesson["exercises"][2]["items"]
    quiz_html = ""
    for idx, it in enumerate(quiz_items):
        # pytanie po polsku, ale odpowiedÅº jest EN â€“ dorzucamy audio do poprawnej odpowiedzi
        quiz_html += f"""
        <div class="card">
          <div class="big" style="font-size:18px">{it['q']}</div>
          <div style="margin-top:8px">
            <input name="q_{idx}" placeholder="OdpowiedÅº">
          </div>
          <div class="muted" style="margin-top:6px">WskazÃ³wka: {it['a']} {tts_btn(it['a'])}</div>
        </div>
        """

    body = f"""
    <div class="grid">
      <div class="card">
        <h2>{lesson['title']}</h2>
        <p class="muted">{lesson['goal']}</p>
        <div class="hr"></div>
        <div><b>Status:</b> {"âœ… Zaliczone" if done else "â–¶ï¸ Do zrobienia"}</div>
        <div class="muted">Ostatni wynik: <b>{(str(score)+"%") if score is not None else "-"}</b></div>

        <div class="hr"></div>

        <h3>1) Mini sÅ‚ownik lekcji</h3>
        <div class="list">{phrases_html}</div>

        <div class="hr"></div>

        <h3>2) Dialog / tekst</h3>
        <div class="list">{dialog_html}</div>
      </div>

      <div class="card">
        <h2>3) Ä†wiczenia (zaliczenie)</h2>
        <p class="muted">Zaliczysz lekcjÄ™, jeÅ›li zdobÄ™dziesz minimum <b>70%</b>.</p>

        <form method="post">
          <div class="hr"></div>
          <h3>{lesson["exercises"][0]["title"]}</h3>
          <div class="list">{match_html}</div>

          <div class="hr"></div>
          <h3>{lesson["exercises"][1]["title"]}</h3>
          <div class="list">{fill_html}</div>

          <div class="hr"></div>
          <h3>{lesson["exercises"][2]["title"]}</h3>
          <div class="list">{quiz_html}</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn" type="submit">SprawdÅº i zakoÅ„cz lekcjÄ™</button>
            <a class="btn btn-ghost" href="{url_for('lessons_list')}">WrÃ³Ä‡</a>
          </div>
        </form>
      </div>
    </div>
    """
    return render(body)


# ----------------------------
# QUIZ
# - ulepszenie: quiz moÅ¼e byÄ‡ "ze sÅ‚ownika" albo "ze wszystkich lekcji"
# - audio: ğŸ”Š przy pytaniu (EN)
# ----------------------------

@app.route("/quiz", methods=["GET", "POST"])
def quiz_page():
    words = load_words()

    mode = (request.args.get("mode", "lessons") or "lessons").strip()  # lessons | dictionary
    direction = (request.args.get("dir", "en_pl") or "en_pl").strip()
    lesson_tag = (request.args.get("lesson", "") or "").strip()  # np. lesson1, lesson31...

    if request.method == "POST":
        mode = request.form.get("mode", "lessons") or "lessons"
        direction = request.form.get("dir", "en_pl") or "en_pl"
        lesson_tag = request.form.get("lesson", "") or ""
        correct_value = request.form.get("correct", "") or ""
        prompt = request.form.get("prompt", "") or ""
        answer = (request.form.get("answer", "") or "").strip()

        if norm(answer) == norm(correct_value):
            flash("Dobrze âœ…", "ok")
        else:
            flash(f"Å¹le âŒ Poprawna: {correct_value}", "err")

        # (opcjonalnie) jeÅ›li quiz dziaÅ‚a na sÅ‚owniku â€“ zapisuj statystyki i SRS
        if mode == "dictionary":
            wid = request.form.get("wid", "")
            w = words.get(wid)
            if w:
                if norm(answer) == norm(correct_value):
                    w.correct += 1
                    schedule_next(w, 4)
                else:
                    w.wrong += 1
                    schedule_next(w, 1)
                save_words(words)

        return redirect(url_for("quiz_page", mode=mode, dir=direction, lesson=lesson_tag))

    # przygotuj pool
    pool = []
    if mode == "dictionary":
        if not words:
            flash("Dodaj najpierw sÅ‚Ã³wka.", "err")
            return redirect(url_for("home"))
        pool = list(words.values())
        if lesson_tag:
            pool = [w for w in pool if lesson_tag in (w.tags or [])]
        if not pool:
            flash("Brak sÅ‚Ã³wek dla wybranego filtra.", "err")
            return redirect(url_for("quiz_page", mode=mode, dir=direction))
        w = random.choice(pool)
        prompt = w.en if direction == "en_pl" else w.pl
        correct_value = w.pl if direction == "en_pl" else w.en
        wid = w.id
        example = w.example or ""
    else:
        # quiz ze wszystkich lekcji (nie wymaga sÅ‚ownika)
        lesson_pool = lesson_phrases_pool(include_dialog=False)
        if lesson_tag:
            lesson_pool = [it for it in lesson_pool if it["tag"] == lesson_tag]
        if not lesson_pool:
            flash("Brak zwrotÃ³w dla wybranego filtra lekcji.", "err")
            return redirect(url_for("quiz_page", mode=mode, dir=direction))
        it = random.choice(lesson_pool)
        prompt = it["en"] if direction == "en_pl" else it["pl"]
        correct_value = it["pl"] if direction == "en_pl" else it["en"]
        wid = ""  # brak ID w sÅ‚owniku
        example = f"Å¹rÃ³dÅ‚o: {it['tag']}"

    # listy filtrÃ³w
    lesson_tags = sorted({f"lesson{l['id']}" for l in LESSONS})
    dict_tags = sorted({t for ww in words.values() for t in (ww.tags or [])}) if words else []

    placeholder = "Wpisz tÅ‚umaczenie po polsku" if direction == "en_pl" else "Wpisz po angielsku"

    body = f"""
    <div class="grid">
      <div class="card">
        <h2>Quiz</h2>

        <form method="get" action="{url_for('quiz_page')}">
          <div class="row">
            <div>
              <label>Tryb</label>
              <select name="mode">
                <option value="lessons" {"selected" if mode=="lessons" else ""}>Ze wszystkich lekcji</option>
                <option value="dictionary" {"selected" if mode=="dictionary" else ""}>Ze sÅ‚ownika</option>
              </select>
            </div>
            <div>
              <label>Kierunek</label>
              <select name="dir">
                <option value="en_pl" {"selected" if direction=="en_pl" else ""}>EN â†’ PL</option>
                <option value="pl_en" {"selected" if direction=="pl_en" else ""}>PL â†’ EN</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Filtr lekcji (opcjonalnie)</label>
              <select name="lesson">
                <option value="">(wszystkie)</option>
                {''.join([f'<option value="{t}" {"selected" if t==lesson_tag else ""}>{t}</option>' for t in lesson_tags])}
              </select>
            </div>
            <div>
              <label>Filtr tagu (dla sÅ‚ownika)</label>
              <select name="lesson" disabled style="opacity:.5">
                <option>(uÅ¼yj w sÅ‚owniku)</option>
              </select>
            </div>
          </div>

          <div class="actions" style="margin-top:10px">
            <button class="btn" type="submit">Ustaw</button>
            <a class="btn btn-ghost" href="{url_for('quiz_page')}">Reset</a>
          </div>
        </form>

        <div class="hr"></div>

        <h3>Pytanie</h3>
        <div class="card" style="margin-top:10px">
          <div class="big">{prompt} {tts_btn(prompt, "lg")}</div>
          <div class="muted" style="margin-top:8px">{example}</div>
        </div>

        <form method="post" style="margin-top:10px">
          <input type="hidden" name="mode" value="{mode}">
          <input type="hidden" name="wid" value="{wid}">
          <input type="hidden" name="dir" value="{direction}">
          <input type="hidden" name="lesson" value="{lesson_tag}">
          <input type="hidden" name="prompt" value="{html_escape.escape(prompt, quote=True)}">
          <input type="hidden" name="correct" value="{html_escape.escape(correct_value, quote=True)}">

          <label>OdpowiedÅº</label>
          <input name="answer" placeholder="{placeholder}" autofocus required>
          <div class="actions" style="margin-top:10px">
            <button class="btn" type="submit">SprawdÅº</button>
            <a class="btn btn-ghost" href="{url_for('lessons_list')}">Lekcje</a>
            <a class="btn btn-ghost" href="{url_for('materials_list')}">MateriaÅ‚y</a>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Tip</h2>
        <p class="muted">
          ğŸ”Š Klikaj przy EN, a w menu <b>Audio</b> ustawisz gÅ‚os i szybkoÅ›Ä‡.
          <br>Tryb <b>Ze wszystkich lekcji</b> nie wymaga dodawania sÅ‚Ã³wek do sÅ‚ownika.
        </p>
      </div>
    </div>
    """
    return render(body)


# ----------------------------
# POWTÃ“RKI (SRS)
# ----------------------------

@app.route("/review", methods=["GET", "POST"])
def review_page():
    words = load_words()
    tag = (request.args.get("tag", "") or "").strip()

    due = due_words(words, tag=tag)
    due.sort(key=lambda w: parse_iso(w.next_review))
    all_tags = sorted({t for ww in words.values() for t in (ww.tags or [])})

    if request.method == "POST":
        wid = request.form.get("wid", "")
        grade = int(request.form.get("grade", "0"))
        tag = request.form.get("tag", "") or ""

        w = words.get(wid)
        if not w:
            flash("BÅ‚Ä…d: brak sÅ‚Ã³wka.", "err")
            return redirect(url_for("review_page", tag=tag))

        if grade >= 3:
            w.correct += 1
        else:
            w.wrong += 1

        schedule_next(w, grade)
        save_words(words)
        return redirect(url_for("review_page", tag=tag))

    if not due:
        body = f"""
        <div class="card">
          <h2>PowtÃ³rki (SRS)</h2>
          <p class="muted">Nie masz nic do powtÃ³rki{(" w tagu: " + tag) if tag else ""}. ğŸ‰</p>
          <div class="actions">
            <a class="btn" href="{url_for('quiz_page', mode='dictionary', lesson=tag)}">ZrÃ³b quiz</a>
            <a class="btn btn-ghost" href="{url_for('words_page')}">SÅ‚ownik</a>
          </div>

          <div class="hr"></div>

          <form method="get" action="{url_for('review_page')}">
            <label>Filtr tagu</label>
            <select name="tag">
              <option value="">(wszystkie)</option>
              {''.join([f'<option value="{t}" {"selected" if t==tag else ""}>{t}</option>' for t in all_tags])}
            </select>
            <div class="actions" style="margin-top:10px">
              <button class="btn" type="submit">Ustaw</button>
              <a class="btn btn-ghost" href="{url_for('review_page')}">Reset</a>
            </div>
          </form>
        </div>
        """
        return render(body)

    w = due[0]
    tags_html = "".join([f'<span class="pill">{t}</span>' for t in (w.tags or [])])

    body = f"""
    <div class="grid">
      <div class="card">
        <h2>PowtÃ³rki (SRS)</h2>

        <form method="get" action="{url_for('review_page')}">
          <label>Filtr tagu</label>
          <select name="tag">
            <option value="">(wszystkie)</option>
            {''.join([f'<option value="{t}" {"selected" if t==tag else ""}>{t}</option>' for t in all_tags])}
          </select>
          <div class="actions" style="margin-top:10px">
            <button class="btn" type="submit">Ustaw</button>
            <a class="btn btn-ghost" href="{url_for('review_page')}">Reset</a>
          </div>
        </form>

        <div class="hr"></div>

        <div class="card">
          <div>{tags_html}</div>
          <div class="big" style="margin-top:8px">{w.en} {tts_btn(w.en)}</div>
          <div class="muted" style="margin-top:6px">PL: <b>{w.pl}</b></div>
          <div class="muted" style="margin-top:6px">{w.example or ""}</div>
          {f'<div class="muted" style="margin-top:6px">{w.notes}</div>' if w.notes else ''}

          <div class="hr"></div>
          <div class="muted">OceÅ„, jak dobrze pamiÄ™tasz (0â€“5). To ustawi nastÄ™pnÄ… powtÃ³rkÄ™.</div>

          <form method="post" style="margin-top:10px">
            <input type="hidden" name="wid" value="{w.id}">
            <input type="hidden" name="tag" value="{tag}">
            <div class="actions">
              {''.join([f'<button class="btn btn-ghost" name="grade" value="{g}" type="submit">{g}</button>' for g in range(0,6)])}
            </div>
          </form>
        </div>

        <p class="muted" style="margin-top:10px">Do powtÃ³rki teraz: <b>{len(due)}</b></p>
      </div>

      <div class="card">
        <h2>WskazÃ³wka</h2>
        <p class="muted">Uczysz siÄ™ pod temat? Filtruj tag (np. <code>airport</code> lub <code>restaurant</code>).</p>
      </div>
    </div>
    """
    return render(body)


# ----------------------------
# STATYSTYKI
# ----------------------------

@app.route("/stats")
def stats_page():
    words = load_words()
    total = len(words)
    correct = sum(w.correct for w in words.values())
    wrong = sum(w.wrong for w in words.values())
    due = len(due_words(words))
    learned = sum(1 for w in words.values() if w.reps >= 3)

    hardest = sorted(words.values(), key=lambda w: (w.wrong - w.correct), reverse=True)[:8]
    hardest_html = ""
    for w in hardest:
        score = w.wrong - w.correct
        hardest_html += f"""
        <div class="card">
          <b>{w.en}</b> {tts_btn(w.en)} â†’ {w.pl}<br>
          <span class="muted">poprawne: {w.correct} â€¢ bÅ‚Ä™dne: {w.wrong} â€¢ bilans: {score}</span>
        </div>
        """

    body = f"""
    <div class="grid">
      <div class="card">
        <h2>Statystyki</h2>
        <p class="muted">SÅ‚Ã³wka: <b>{total}</b></p>
        <p class="muted">Poprawne / bÅ‚Ä™dne: <b>{correct}</b> / <b>{wrong}</b></p>
        <p class="muted">Do powtÃ³rki dziÅ›: <b>{due}</b></p>
        <p class="muted">Utrwalone (reps â‰¥ 3): <b>{learned}</b></p>
      </div>

      <div class="card">
        <h2>Najtrudniejsze</h2>
        <div class="list">
          {hardest_html or '<div class="muted">Brak danych.</div>'}
        </div>
      </div>
    </div>
    """
    return render(body)


# ----------------------------
# IMPORT / EKSPORT
# ----------------------------

@app.route("/settings", methods=["GET", "POST"])
def settings_page():
    words = load_words()

    if request.method == "POST":
        action = request.form.get("action", "")

        if action == "export":
            fname = f"words_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            with open(fname, "w", encoding="utf-8") as f:
                json.dump({"words": [w.to_dict() for w in words.values()]}, f, ensure_ascii=False, indent=2)
            flash(f"Wyeksportowano do pliku: {fname}", "ok")
            return redirect(url_for("settings_page"))

        if action == "import":
            raw = (request.form.get("json_data", "") or "").strip()
            try:
                payload = json.loads(raw)
                incoming = payload.get("words", [])
                if not isinstance(incoming, list):
                    raise ValueError("Pole 'words' musi byÄ‡ listÄ….")

                for item in incoming:
                    w = Word.from_dict(item)
                    if not w.id:
                        w.id = f"w{(len(words) + 1):04d}"
                    if not w.created_at:
                        w.created_at = now_iso()
                    if not w.next_review:
                        w.next_review = now_iso()
                    words[w.id] = w

                save_words(words)
                flash(f"Zaimportowano {len(incoming)} rekordÃ³w âœ…", "ok")
            except Exception as e:
                flash(f"BÅ‚Ä…d importu: {e}", "err")

            return redirect(url_for("settings_page"))

        if action == "reset_all":
            words = seed_words()
            save_words(words)
            save_lesson_progress({"completed": {}, "scores": {}})
            flash("Zresetowano bazÄ™ i progres lekcji.", "ok")
            return redirect(url_for("settings_page"))

    preview = json.dumps({"words": [w.to_dict() for w in words.values()]}, ensure_ascii=False, indent=2)

    body = f"""
    <div class="grid">
      <div class="card">
        <h2>Eksport</h2>
        <form method="post">
          <input type="hidden" name="action" value="export">
          <button class="btn" type="submit">Zapisz backup JSON do pliku</button>
        </form>

        <div class="hr"></div>

        <h2>Import</h2>
        <form method="post">
          <input type="hidden" name="action" value="import">
          <label>Wklej JSON</label>
          <textarea name="json_data" placeholder='{"words":[{"id":"w0001","en":"...","pl":"..."}]}'></textarea>
          <div class="actions" style="margin-top:10px">
            <button class="btn" type="submit">Importuj</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>PodglÄ…d danych</h2>
        <textarea readonly>{preview}</textarea>

        <div class="hr"></div>

        <h2>Reset</h2>
        <form method="post" onsubmit="return confirm('Na pewno zresetowaÄ‡ bazÄ™?');">
          <input type="hidden" name="action" value="reset_all">
          <button class="btn danger" type="submit">Resetuj bazÄ™ + progres lekcji</button>
        </form>
      </div>
    </div>
    """
    return render(body)


# ============================
# START
# ============================

if __name__ == "__main__":
    app.run(host="127.0.0.1", port=5000, debug=True)
